{% load static %}

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë‚´ ì•„ì´í…œ</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800 font-sans p-8">

  <h1 class="text-3xl font-bold mb-6 text-center">ğŸ§³ ë‚´ê°€ ë³´ìœ í•œ ì•„ì´í…œ</h1>
  <!-- ğŸ”¸ ë§ì½ì´ ìºë¦­í„°ì™€ íƒ­ ë©”ë‰´ UI -->
  
  <div class="text-center cursor-pointer">
    <div class="flex justify-center items-end gap-6 mb-2">
    
    <!-- âœ… ê¸€ì½ì´ ìºë¦­í„° ê²¹ì³ì§„ êµ¬ì¡° ì‹œì‘ -->
      <div class="text-center cursor-pointer" onclick="selectCharacter('geulssung')">
        <div class="relative w-80 h-80 mx-auto character-geulssung">
          <!-- ê¸°ë³¸ ê¸€ì½ì´ -->
          <img src="{% static 'images/ê¸€ì½ì´.png' %}" class="absolute top-0 left-0 z-10 w-full">

          <!-- ì°©ìš©ëœ ì•„ì´í…œë“¤ (equipped=True) -->
          {% for ui in equipped_items %}
            {% if 'geulssung' in ui.item.image_path and ui.equipped %}
              <img src="{% static ui.item.image_path %}" class="absolute top-0 left-0 z-20 w-full" id="equipped-geulssung-{{ ui.item.id }}">
            {% endif %}
          {% endfor %}
        </div>
        <p class="text-xs mt-1 text-gray-500">ê¸€ì½ì´</p>
      </div>
      <!-- âœ… ê¸€ì½ì´ ìºë¦­í„° ê²¹ì³ì§„ êµ¬ì¡° ë -->

      <!-- ë§ì½ì´ ìºë¦­í„°ëŠ” ê·¸ëŒ€ë¡œ -->
      <!-- ë§ì½ì´ ìºë¦­í„° -->
      <div class="text-center cursor-pointer mt-6" onclick="selectCharacter('malssung')">
        <div class="relative w-80 h-80 mx-auto character-malssung">
          <img src="{% static 'images/ë§ì½ì´.png' %}" class="absolute top-0 left-0 z-10 w-full">
          {% for ui in equipped_items %}
            {% if 'malssung' in ui.item.image_path and ui.equipped %}
              <img src="{% static ui.item.image_path %}" class="absolute top-0 left-0 z-20 w-full" id="equipped-malssung-{{ ui.item.id }}">
            {% endif %}
          {% endfor %}
        </div>
        <p class="text-xs mt-1 text-gray-500">ë§ì½ì´</p>
      </div>
    </div>
    <br>
    <div class="text-center">
      <div id="geulssung-buttons" class="flex justify-center space-x-4">
        <button onclick="activateButton(this, 'ëª¸ì²´')" class="category-btn text-sm px-4 py-1 rounded-full bg-gray-100 text-gray-500 font-semibold transition transform">ëª¸ì²´</button>
        <button onclick="activateButton(this, 'ê°€ë°©')" class="category-btn text-sm px-4 py-1 rounded-full bg-gray-100 text-gray-500 font-semibold transition transform">ê°€ë°©</button>
        <button onclick="activateButton(this, 'ì•ˆê²½')" class="category-btn text-sm px-4 py-1 rounded-full bg-gray-100 text-gray-500 font-semibold transition transform">ì•ˆê²½</button>
        <button onclick="showAllItems()" class="text-sm px-4 py-1 rounded-full bg-gray-100 text-gray-500 font-semibold">ëª¨ë‘ ë³´ê¸°</button>
      </div>

      <div id="malssung-buttons" class="hidden flex justify-center space-x-4">
        <button onclick="activateButton(this, 'ì•…ì„¸ì„œë¦¬')" class="category-btn text-sm px-4 py-1 rounded-full bg-gray-100 text-gray-500 font-semibold transition">ì•…ì„¸ì„œë¦¬</button>
        <button onclick="activateButton(this, 'ì˜·')" class="category-btn text-sm px-4 py-1 rounded-full bg-gray-100 text-gray-500 font-semibold transition">ì˜·</button>
        <button onclick="activateButton(this, 'ëª¨ì')" class="category-btn text-sm px-4 py-1 rounded-full bg-gray-100 text-gray-500 font-semibold transition">ëª¨ì</button>
        <button onclick="showAllItems()" class="text-sm px-4 py-1 rounded-full bg-gray-100 text-gray-500 font-semibold">ëª¨ë‘ ë³´ê¸°</button>
      </div>
    </div>
    <br>
    <br>
  </div>

  <!-- ğŸ”¹ ë³´ìœ  ì•„ì´í…œ ì˜ì—­ -->

  <div id="item-section" class="mt-6 mb-20 transition-all duration-300 flex justify-center">
    <div class="grid grid-cols-2 md:grid-cols-4 gap-6 max-w-5xl">
      {% for ui in owned_items %}
      <div class="item-card hidden inline-block text-center"
             data-character="{% if 'geulssung' in ui.item.image_path %}geulssung{% elif 'malssung' in ui.item.image_path %}malssung{% endif %}"
            data-category="{% if 'body' in ui.item.image_path %}ëª¸ì²´{% elif 'bag' in ui.item.image_path %}ê°€ë°©{% elif 'glass' in ui.item.image_path %}ì•ˆê²½{% elif 'acc' in ui.item.image_path %}ì•…ì„¸ì„œë¦¬{% elif 'clothes' in ui.item.image_path %}ì˜·{% elif 'head' in ui.item.image_path %}ëª¨ì{% else %}ê¸°íƒ€{% endif %}">
          <img src="{% static ui.item.image_path %}"
              onclick="toggleEquip('{{ ui.item.id }}')"
              class="w-52 h-52 rounded shadow cursor-pointer hover:scale-110 transition">
          <p class="text-xs mt-1">
            {% if ui.equipped %}
              <span class="text-green-500">ì°©ìš© ì¤‘</span>
            {% else %}
              <span class="text-gray-400">ë¯¸ì°©ìš©</span>
            {% endif %}
          </p>
        </div>
      {% endfor %}
    </div>
  </div>

    <script>
      let selectedCharacter = null;
      let selectedCategory = null;

      // ğŸ”¹ ìºë¦­í„° ì„ íƒ ì‹œ í•„í„°ë§
      function selectCharacter(character) {
        selectedCharacter = character;
        selectedCategory = null;

        console.log("ì„ íƒëœ ìºë¦­í„°:", character); // ë””ë²„ê¹…ìš©
        
        document.getElementById('geulssung-buttons').classList.toggle('hidden', character !== 'geulssung');
        document.getElementById('malssung-buttons').classList.toggle('hidden', character !== 'malssung');

        filterItems();
      }

      // ğŸ”¹ ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ í´ë¦­ ì‹œ í•„í„°ë§
      function activateButton(button, category) {
        selectedCategory = category;

        document.querySelectorAll(".category-btn").forEach(btn => {
          btn.classList.remove("bg-[#00C9A7]", "text-white");
          btn.classList.add("bg-gray-100", "text-gray-500");
        });

        button.classList.remove("bg-gray-100", "text-gray-500");
        button.classList.add("bg-[#00C9A7]", "text-white");

        filterItems();
      }

      // ğŸ”¹ ì•„ì´í…œ ëª©ë¡ í•„í„°ë§
      function filterItems() {
        document.querySelectorAll(".item-card").forEach(card => {
          const matchChar = selectedCharacter === null || card.dataset.character === selectedCharacter;
          const matchCat = selectedCategory === null || card.dataset.category === selectedCategory;

          card.classList.toggle("hidden", !(matchChar && matchCat));
        });
      }

      // ğŸ”¹ 'ëª¨ë‘ ë³´ê¸°' í´ë¦­ ì‹œ í•„í„° í•´ì œ
      function showAllItems() {
        selectedCategory = null;

        document.querySelectorAll(".category-btn").forEach(btn => {
          btn.classList.remove("bg-[#00C9A7]", "text-white");
          btn.classList.add("bg-gray-100", "text-gray-500");
        });

        filterItems();
      }

      // ğŸ”¹ ì¥ì°©/í•´ì œ ë¹„ë™ê¸° ì²˜ë¦¬
      function toggleEquip(itemId) {
        fetch(`/my-items/toggle-equip/${itemId}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            updateItemStatus(itemId, data.equipped, data.image_path);
          } else {
            alert("ì²˜ë¦¬ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          }
        });
      }

      function updateItemStatus(itemId, equipped, imagePath) {
        const itemCard = document.querySelector(`[onclick="toggleEquip('${itemId}')"]`).closest('.item-card');
        const statusSpan = itemCard.querySelector('p span');

        const isMalssung = imagePath.includes('malssung');
        const targetContainerSelector = isMalssung ? '.character-malssung' : '.character-geulssung';
        const targetContainer = document.querySelector(targetContainerSelector);

        const partMatch = imagePath.match(/(body|bag|glass|acc|clothes|head)/);
        const part = partMatch ? partMatch[1] : null;

        // ê¸°ì¡´ ë™ì¼ ë¶€ìœ„ ì´ë¯¸ì§€ ì œê±°
        if (part) {
          const oldImg = targetContainer.querySelector(`img[data-part="${part}"]`);
          if (oldImg) oldImg.remove();
        }

        // ëª¨ë“  í•´ë‹¹ ë¶€ìœ„ì˜ ì•„ì´í…œ í…ìŠ¤íŠ¸ ìƒíƒœ ë¯¸ì°©ìš©ìœ¼ë¡œ ì´ˆê¸°í™”
        document.querySelectorAll(".item-card").forEach(card => {
          if (
            card.dataset.character === (isMalssung ? 'malssung' : 'geulssung') &&
            card.dataset.category === convertPartToKorean(part)
          ) {
            const span = card.querySelector('p span');
            span.innerText = 'ë¯¸ì°©ìš©';
            span.classList.remove('text-green-500');
            span.classList.add('text-gray-400');
          }
        });

        if (equipped) {
          // í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
          statusSpan.innerText = 'ì°©ìš© ì¤‘';
          statusSpan.classList.remove('text-gray-400');
          statusSpan.classList.add('text-green-500');

          // ìƒˆë¡œìš´ ì´ë¯¸ì§€ ì¶”ê°€
          const img = document.createElement('img');
          img.src = imagePath.startsWith('/static/') ? imagePath : '/static/' + imagePath;
          img.className = 'absolute top-0 left-0 z-20 w-full';
          img.setAttribute('data-part', part);
          targetContainer.appendChild(img);
        }
      }

  </script>
</body>
</html>


