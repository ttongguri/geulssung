{% load static %}
<!DOCTYPE html>
<html lang="ko" style="font-size: 80%;">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ›’ìƒì </title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Font -->
  <style>@import url('https://fonts.googleapis.com/css2?family=Gowun+Batang&display=swap');</style>
</head>
<body class="bg-[#f0f9ff] text-gray-800 font-sans p-8">
  
  {% include "nav_bar.html" %}
  <br>
  <br>
  <br>
  
  <h1 class="text-3xl font-bold mb-2 text-center">ğŸ€ ê¸€ë§ì½ì´ ì˜·ì¥</h1>
  <!-- ğŸ”¸ ìºë¦­í„° íƒ­ UI (ë„ìš°ë¯¸ ìƒì  ë²„íŠ¼ í¬í•¨) -->

    <!-- ğŸ›’ ë„ìš°ë¯¸ ìƒì  ë²„íŠ¼: ìƒë‹¨ ì¤‘ì•™ ê³ ì • -->
      <div class="absolute top-2 left-1/2 transform -translate-x-1/2 z-50 flex items-center gap-4 bg-white px-4 py-2 rounded-full shadow">
        <a href="{% url 'store' %}" 
          class="text-sm bg-[#00C9A7] hover:bg-[#00b498] text-white font-semibold px-3 py-1 rounded-full shadow transition">
          ğŸ›’ ë„ìš°ë¯¸ ìƒì  ê°€ê¸°
        </a>
        <p class="text-sm font-semibold text-gray-700">
          í˜„ì¬ ë³´ìœ  ë”°ê°œë¹„: <span id="user-credit" class="text-red-500">{{ user.credit }}</span> ê°œ
        </p>
      </div>  

    <!-- ğŸ”¹ ìºë¦­í„° ì„ íƒ ì˜ì—­ (ë²„íŠ¼ê³¼ ê²¹ì¹˜ì§€ ì•Šë„ë¡ mt ì¶”ê°€) -->
    <div class="flex justify-center items-end gap-4 mt-[-20px]">
      {% for char in characters %}
        <div class="text-center cursor-pointer" onclick="selectCharacter({{ char.id }})">
          {% include "customizing/character_render.html" with character=char equipped_items=equipped_items %}
          <p class="text-xs mt-1 text-gray-500">{{ char.name }}</p>
        </div>
      {% endfor %}
    </div>
    <br>
    <div class="text-center">
      <div id="char-1-buttons" class="flex justify-center gap-4">
        <input type="radio" name="part-char1" value="ëª¸ì²´" id="char1-body" class="hidden peer/body" onchange="activateCategory('ëª¸ì²´')">
        <label for="char1-body"
          class="bg-white text-[#493E3E] px-4 py-2 rounded-full border border-gray-300 font-semibold cursor-pointer transition 
                peer-checked/body:bg-[#00C9A7] peer-checked/body:text-white">
          ëª¸ì²´
        </label>

        <input type="radio" name="part-char1" value="ê°€ë°©" id="char1-bag" class="hidden peer/bag" onchange="activateCategory('ê°€ë°©')">
        <label for="char1-bag"
          class="bg-white text-[#493E3E] px-4 py-2 rounded-full border border-gray-300 font-semibold cursor-pointer transition 
                peer-checked/bag:bg-[#00C9A7] peer-checked/bag:text-white">
          ê°€ë°©
        </label>

        <input type="radio" name="part-char1" value="ì•ˆê²½" id="char1-glass" class="hidden peer/glass" onchange="activateCategory('ì•ˆê²½')">
        <label for="char1-glass"
          class="bg-white text-[#493E3E] px-4 py-2 rounded-full border border-gray-300 font-semibold cursor-pointer transition 
                peer-checked/glass:bg-[#00C9A7] peer-checked/glass:text-white">
          ì•ˆê²½
        </label>

        <input type="radio" name="part-char1" value="" id="char1-all" class="hidden peer/all" onchange="showAllItems()">
        <label for="char1-all"
          class="bg-white text-[#493E3E] px-4 py-2 rounded-full border border-gray-300 font-semibold cursor-pointer transition 
                peer-checked/all:bg-[#00C9A7] peer-checked/all:text-white">
          ëª¨ë‘ ë³´ê¸°
        </label>
      </div>


      <div id="char-2-buttons" class="flex justify-center gap-4 hidden">
        <input type="radio" name="part-char2" value="ì•…ì„¸ì„œë¦¬" id="char2-acc" class="hidden peer/acc" onchange="activateCategory('ì•…ì„¸ì„œë¦¬')">
        <label for="char2-acc"
          class="bg-white text-[#493E3E] px-4 py-2 rounded-full border border-gray-300 font-semibold cursor-pointer transition 
                peer-checked/acc:bg-[#00C9A7] peer-checked/acc:text-white">
          ì•…ì„¸ì„œë¦¬
        </label>

        <input type="radio" name="part-char2" value="ì˜·" id="char2-clothes" class="hidden peer/clothes" onchange="activateCategory('ì˜·')">
        <label for="char2-clothes"
          class="bg-white text-[#493E3E] px-4 py-2 rounded-full border border-gray-300 font-semibold cursor-pointer transition 
                peer-checked/clothes:bg-[#00C9A7] peer-checked/clothes:text-white">
          ì˜·
        </label>

        <input type="radio" name="part-char2" value="ëª¨ì" id="char2-head" class="hidden peer/head" onchange="activateCategory('ëª¨ì')">
        <label for="char2-head"
          class="bg-white text-[#493E3E] px-4 py-2 rounded-full border border-gray-300 font-semibold cursor-pointer transition 
                peer-checked/head:bg-[#00C9A7] peer-checked/head:text-white">
          ëª¨ì
        </label>

        <input type="radio" name="part-char2" value="" id="char2-all" class="hidden peer/all" onchange="showAllItems()">
        <label for="char2-all"
          class="bg-white text-[#493E3E] px-4 py-2 rounded-full border border-gray-300 font-semibold cursor-pointer transition 
                peer-checked/all:bg-[#00C9A7] peer-checked/all:text-white">
          ëª¨ë‘ ë³´ê¸°
        </label>
      </div>
    </div>
    <br><br>

  <!-- ğŸ”¹ ì•„ì´í…œ ì¹´ë“œ ì¤‘ì•™ ì •ë ¬ -->
    <div class="flex justify-center">
      <div id="all-items" class="grid grid-cols-5 gap-6">
        {% for ui in owned_items %}
          {% with path=ui.item.image_path char_id=ui.item.character.id %}
            {% if not 'clothes' in path %}
              <div class="item-card hidden inline-block text-center"
                  data-character="{{ char_id }}"
                  data-category="{% if 'body' in path %}ëª¸ì²´{% elif 'bag' in path %}ê°€ë°©{% elif 'glass' in path %}ì•ˆê²½{% elif 'acc' in path %}ì•…ì„¸ì„œë¦¬{% elif 'head' in path %}ëª¨ì{% elif 'clothes' in path %}ì˜·{% else %}ê¸°íƒ€{% endif %}">
                <img src="{% static ui.item.image_path %}"
                    onclick="toggleEquip('{{ ui.item.id }}')"
                    class="w-52 h-52 rounded shadow cursor-pointer hover:scale-110 transition">
                <p class="text-xs mt-1">
                  {% if ui.equipped %}
                    <span class="text-green-500">ì°©ìš© ì¤‘</span>
                  {% else %}
                    <span class="text-gray-400">ë¯¸ì°©ìš©</span>
                  {% endif %}
                </p>
              </div>
            {% endif %}
          {% endwith %}
        {% endfor %}

        {% for ui in owned_items %}
          {% with path=ui.item.image_path char_id=ui.item.character.id %}
            {% if 'clothes' in path %}
              <div class="item-card hidden inline-block text-center"
                  data-character="{{ char_id }}"
                  data-category="{% if 'body' in path %}ëª¸ì²´{% elif 'bag' in path %}ê°€ë°©{% elif 'glass' in path %}ì•ˆê²½{% elif 'acc' in path %}ì•…ì„¸ì„œë¦¬{% elif 'head' in path %}ëª¨ì{% elif 'clothes' in path %}ì˜·{% else %}ê¸°íƒ€{% endif %}">
                <img src="{% static ui.item.image_path %}"
                    onclick="toggleEquip('{{ ui.item.id }}')"
                    class="w-52 h-52 rounded shadow cursor-pointer hover:scale-110 transition">
                <p class="text-xs mt-1">
                  {% if ui.equipped %}
                    <span class="text-green-500">ì°©ìš© ì¤‘</span>
                  {% else %}
                    <span class="text-gray-400">ë¯¸ì°©ìš©</span>
                  {% endif %}
                </p>
              </div>
            {% endif %}
          {% endwith %}
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- ğŸ”¹ í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ -->
  <div class="flex justify-center mt-6 space-x-2" id="pagination"></div>
  <br>
  <br>

<script>
  let selectedCharacter = 1; // ê¸°ë³¸: ê¸€ì½ì´
  let selectedCategory = null;

  // ğŸ”¹ ì´ˆê¸° ì¥ì°© ì•„ì´í…œ mount (id ê¸°ë°˜)
  const initialEquippedItems = [
    {% for ui in equipped_items %}
      {% with path=ui.item.image_path char_id=ui.item.character.id %}
        {% if ui.equipped %}
          {
            id: {{ ui.item.id }},
            image_path: "{% static ui.item.image_path %}",
            character: {{ char_id }},
            part: "{% if 'body' in path %}body{% elif 'bag' in path %}bag{% elif 'glass' in path %}glass{% elif 'acc' in path %}acc{% elif 'clothes' in path %}clothes{% elif 'head' in path %}head{% endif %}"
          },
        {% endif %}
      {% endwith %}
    {% endfor %}
  ];
  

  window.addEventListener('DOMContentLoaded', () => {
    initialEquippedItems.forEach(item => {
      const target = document.querySelector(`.character-${item.character}`);
      if (!target) return;
      const img = document.createElement('img');
      img.src = item.image_path;
      img.className = 'absolute top-0 left-0 w-full';
      img.setAttribute('data-part', item.part);
      img.style.zIndex = item.part === 'body' ? '10' : '20';
      const base = target.querySelector('img');
      if (item.part === 'body' && base && base.nextSibling) {
        target.insertBefore(img, base.nextSibling);
      } else {
        target.appendChild(img);
      }
    });

    // ê¸°ë³¸ ê¸€ì½ì´ ë²„íŠ¼ë§Œ ë³´ì´ê²Œ
    document.getElementById('char-1-buttons').classList.remove('hidden');
    document.getElementById('char-2-buttons').classList.add('hidden');
    filterItems();
  });

  // ğŸ”¹ ìºë¦­í„° ì„ íƒ (id ê¸°ë°˜)
  function selectCharacter(characterId) {
    selectedCharacter = characterId;
    selectedCategory = null;
    document.getElementById('char-1-buttons').classList.toggle('hidden', characterId !== 1);
    document.getElementById('char-2-buttons').classList.toggle('hidden', characterId !== 2);

      // âœ… ëª¨ë‘ ë³´ê¸° ë²„íŠ¼ ì²´í¬í•´ì£¼ê¸°
    if (characterId === 1) {
      document.getElementById('char1-all').checked = true;
    } else if (characterId === 2) {
      document.getElementById('char2-all').checked = true;
    }

    filterItems();
  }

  // ğŸ”¹ ë¶€ìœ„ ë²„íŠ¼ í´ë¦­ ì‹œ
  function activateButton(button, category) {
    selectedCategory = category;
    document.querySelectorAll('.category-btn').forEach(btn => {
      btn.classList.remove('bg-[#00C9A7]', 'text-white');
      btn.classList.add('bg-gray-100', 'text-gray-500');
    });
    button.classList.remove('bg-gray-100', 'text-gray-500');
    button.classList.add('bg-[#00C9A7]', 'text-white');
    filterItems();
  }

  // ğŸ”¹ ì•„ì´í…œ í•„í„°ë§ (id ê¸°ë°˜)
  function filterItems() {
    const filtered = allItems.filter(card => {
      const cardChar = Number(card.dataset.character);
      const cardCat = card.dataset.category?.trim(); // í˜¹ì‹œ ê³µë°± í¬í•¨ë˜ì–´ ìˆì„ ìˆ˜ ìˆì–´ì„œ
      const matchChar = cardChar === selectedCharacter;
      const matchCat = selectedCategory === null || cardCat === selectedCategory;
      return matchChar && matchCat;
    });

    allItems.forEach(card => {
      card.classList.add('hidden');
      card.classList.remove('inline-block');
    });

    filtered.forEach((card, idx) => {
      if (idx < ITEMS_PER_PAGE) {
        card.classList.remove('hidden');
        card.classList.add('inline-block');
      }
    });

    renderPaginationFiltered(filtered);
  }



  // ğŸ”¹ ëª¨ë‘ ë³´ê¸°
  function showAllItems() {
    selectedCategory = null;
    document.querySelectorAll('.category-btn').forEach(btn => {
      btn.classList.remove('bg-[#00C9A7]', 'text-white');
      btn.classList.add('bg-gray-100', 'text-gray-500');
    });
    filterItems();
  }

  // ğŸ”¹ ì¥ì°©/í•´ì œ toggle (id ê¸°ë°˜)
  function toggleEquip(itemId) {
    const clickedCard = document.querySelector(`[onclick="toggleEquip('${itemId}')"]`).closest('.item-card');
    const statusSpan = clickedCard.querySelector('p span');
    const isCurrentlyEquipped = statusSpan.innerText === 'ì°©ìš© ì¤‘';
    // ì„ ë°˜ì˜
    statusSpan.innerText = isCurrentlyEquipped ? 'ë¯¸ì°©ìš©' : 'ì°©ìš© ì¤‘';
    statusSpan.classList.toggle('text-green-500', !isCurrentlyEquipped);
    statusSpan.classList.toggle('text-gray-400', isCurrentlyEquipped);
    fetch(`/my-items/toggle-equip/${itemId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        updateItemStatus(itemId, data.equipped, data.image_path);
      } else {
        // ë¡¤ë°±
        statusSpan.innerText = isCurrentlyEquipped ? 'ì°©ìš© ì¤‘' : 'ë¯¸ì°©ìš©';
        statusSpan.classList.toggle('text-green-500', isCurrentlyEquipped);
        statusSpan.classList.toggle('text-gray-400', !isCurrentlyEquipped);
        alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });
  }

  // ğŸ”¹ ì¥ì°© ìƒíƒœ ë°˜ì˜ (id ê¸°ë°˜)
  function updateItemStatus(itemId, equipped, imagePath) {
    // ìºë¦­í„° id ì¶”ì¶œ (ê¸€ì½ì´: 1, ë§ì½ì´: 2)
    let character = imagePath.includes('malssung') ? 2 : 1;
    const targetContainer = document.querySelector(`.character-${character}`);
    const partMatch = imagePath.match(/(body|bag|glass|acc|clothes|head)/);
    const part = partMatch ? partMatch[1] : null;
    const categoryKor = convertPartToKorean(part);
    // ê¸°ì¡´ ìºë¦­í„° ì´ë¯¸ì§€ ì œê±° (í•´ë‹¹ íŒŒì¸ ë§Œ)
    const existingImgs = targetContainer.querySelectorAll(`img[data-part="${part}"]`);
    existingImgs.forEach(img => img.remove());
    // í…ìŠ¤íŠ¸ ì´ˆê¸°í™” (ê°™ì€ ë¶€ìœ„ì˜ ëª¨ë“  ì¹´ë“œ)
    document.querySelectorAll(`.item-card[data-character="${character}"][data-category="${categoryKor}"]`).forEach(card => {
      const span = card.querySelector('p span');
      span.innerText = 'ë¯¸ì°©ìš©';
      span.classList.remove('text-green-500');
      span.classList.add('text-gray-400');
    });
    // ì´ë¯¸ì§€ ì¶”ê°€
    if (equipped) {
      const img = document.createElement('img');
      img.src = imagePath.startsWith('/static/') ? imagePath : '/static/' + imagePath;
      img.className = 'absolute top-0 left-0 w-full';
      img.setAttribute('data-part', part);
      img.style.zIndex = part === 'body' ? '10' : '20';
      const baseImg = targetContainer.querySelector('img:not([data-part])');
      if (part === 'body' && baseImg && baseImg.nextSibling) {
        targetContainer.insertBefore(img, baseImg.nextSibling);
      } else {
        targetContainer.appendChild(img);
      }
      // ì¹´ë“œì—ë„ í…ìŠ¤íŠ¸ ë°˜ì˜
      const thisCard = document.querySelector(`[onclick="toggleEquip('${itemId}')"]`).closest('.item-card');
      const statusSpan = thisCard.querySelector('p span');
      statusSpan.innerText = 'ì°©ìš© ì¤‘';
      statusSpan.classList.remove('text-gray-400');
      statusSpan.classList.add('text-green-500');
    }
  }

  function convertPartToKorean(part) {
    switch (part) {
      case 'body': return 'ëª¸ì²´';
      case 'bag': return 'ê°€ë°©';
      case 'glass': return 'ì•ˆê²½';
      case 'acc': return 'ì•…ì„¸ì„œë¦¬';
      case 'clothes': return 'ì˜·';
      case 'head': return 'ëª¨ì';
      default: return '';
    }
  }

  const ITEMS_PER_PAGE = 5;

  const allItems = Array.from(document.querySelectorAll('.item-card'));
  const pagedContainer = document.getElementById('all-items');
  const pagination = document.getElementById('pagination');

  let currentPage = 1;

  function renderPage(page) {
    const start = (page - 1) * ITEMS_PER_PAGE;
    const end = start + ITEMS_PER_PAGE;

    allItems.forEach((item, index) => {
      if (index >= start && index < end) {
        item.classList.remove('hidden');
        item.classList.add('inline-block');
      } else {
        item.classList.add('hidden');
        item.classList.remove('inline-block');
      }
    });

    renderPagination(page);
  }

  function renderPaginationFiltered(filteredItems) {
    const totalPages = Math.ceil(filteredItems.length / ITEMS_PER_PAGE);
    pagination.innerHTML = '';

    for (let i = 1; i <= totalPages; i++) {
      const btn = document.createElement('button');
      btn.textContent = i;
      btn.className = `px-3 py-1 rounded-full border text-sm font-semibold ${
        i === 1 ? 'bg-blue-500 text-white' : 'bg-white text-gray-700'
      } hover:bg-blue-100 hover:text-black transition`;
      btn.addEventListener('click', () => {
        filteredItems.forEach((card, idx) => {
          card.classList.toggle('hidden', !(idx >= (i - 1) * ITEMS_PER_PAGE && idx < i * ITEMS_PER_PAGE));
          card.classList.toggle('inline-block', idx >= (i - 1) * ITEMS_PER_PAGE && idx < i * ITEMS_PER_PAGE);
        });

        // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ê°±ì‹ 
        Array.from(pagination.children).forEach((b, idx) => {
          if (idx === i - 1) {
            b.classList.remove('bg-white', 'text-gray-700');
            b.classList.add('bg-blue-500', 'text-white');
          } else {
            b.classList.add('bg-white', 'text-gray-700');
            b.classList.remove('bg-blue-500', 'text-white');
          }
        });
      });
      pagination.appendChild(btn);
    }
  }

  function activateCategory(category) {
  selectedCategory = category;
  filterItems();
  }
</script>
  
</body>
</html>