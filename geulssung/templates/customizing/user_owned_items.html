{% load static %}

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë‚´ ì•„ì´í…œ</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800 font-sans p-8">

  <h1 class="text-3xl font-bold mb-6 text-center">âœ¨ ë‚´ê°€ ë³´ìœ í•œ ì•„ì´í…œ âœ¨</h1>
  <br>
  <br>
  <!-- ğŸ”¸ ë§ì½ì´ ìºë¦­í„°ì™€ íƒ­ ë©”ë‰´ UI -->
  
  <div class="text-center cursor-pointer">
    <div class="flex justify-center items-end gap-6 mb-2">
      <div class="relative w-full max-w-4xl mx-auto">
        <!-- ğŸ”¸ ìƒë‹¨ ì¤‘ì•™ ë²„íŠ¼ -->
        <a href="{% url 'store' %}" 
        class="{% if request.path == '/geulssung/customizing/store' %} absolute -top-5 left-1/2 transform -translate-x-1/2 {% endif %} bg-[#00C9A7] hover:bg-[#00b498] text-black text-sm font-bold px-4 py-2 rounded-full shadow">
        ë„ìš°ë¯¸ ìƒì  ê°€ê¸°
        </a>
      
      <div class="flex justify-center items-end gap-6 border-2 border-gray rounded-full px-6 py-4 w-full max-w-4xl mx-auto">
      <!-- âœ… ê¸€ì½ì´ ìºë¦­í„° ê²¹ì³ì§„ êµ¬ì¡° ì‹œì‘ -->
          <div class="text-center cursor-pointer" onclick="selectCharacter('geulssung')">
            <div class="relative w-80 h-80 mx-auto character-geulssung" id="geulssung-container">
              <img src="{% static 'images/character/geulssung/geulssung_default.png' %}" class="absolute top-0 left-0 z-10 w-full">
            </div>
            <p class="text-xs mt-1 text-gray-500">ğŸŒ ê¸€ì½ì´</p>
          </div>
          <!-- âœ… ê¸€ì½ì´ ìºë¦­í„° ê²¹ì³ì§„ êµ¬ì¡° ë -->

          <!-- ë§ì½ì´ ìºë¦­í„° -->
          <div class="text-center cursor-pointer" onclick="selectCharacter('malssung')">
            <div class="relative w-80 h-80 mx-auto character-malssung" id="malssung-container">
              <img src="{% static 'images/character/malssung/malssung_default.png' %}" class="absolute top-0 left-0 z-10 w-full">
            </div>
            <p class="text-xs mt-1 text-gray-500">ğŸŒ ë§ì½ì´</p>
          </div>
        </div>
      </div>
    </div>
    <br>
    <div class="text-center">
      <div id="geulssung-buttons" class="flex justify-center space-x-4">
        <button onclick="activateButton(this, 'ëª¸ì²´')" class="category-btn text-sm px-4 py-1 rounded-full bg-gray-100 text-gray-500 font-semibold transition transform">ëª¸ì²´</button>
        <button onclick="activateButton(this, 'ê°€ë°©')" class="category-btn text-sm px-4 py-1 rounded-full bg-gray-100 text-gray-500 font-semibold transition transform">ê°€ë°©</button>
        <button onclick="activateButton(this, 'ì•ˆê²½')" class="category-btn text-sm px-4 py-1 rounded-full bg-gray-100 text-gray-500 font-semibold transition transform">ì•ˆê²½</button>
        <button onclick="showAllItems()" class="text-sm px-4 py-1 rounded-full bg-gray-100 text-gray-500 font-semibold">ëª¨ë‘ ë³´ê¸°</button>
      </div>

      <div id="malssung-buttons" class="hidden flex justify-center space-x-4">
        <button onclick="activateButton(this, 'ì•…ì„¸ì„œë¦¬')" class="category-btn text-sm px-4 py-1 rounded-full bg-gray-100 text-gray-500 font-semibold transition">ì•…ì„¸ì„œë¦¬</button>
        <button onclick="activateButton(this, 'ì˜·')" class="category-btn text-sm px-4 py-1 rounded-full bg-gray-100 text-gray-500 font-semibold transition">ì˜·</button>
        <button onclick="activateButton(this, 'ëª¨ì')" class="category-btn text-sm px-4 py-1 rounded-full bg-gray-100 text-gray-500 font-semibold transition">ëª¨ì</button>
        <button onclick="showAllItems()" class="text-sm px-4 py-1 rounded-full bg-gray-100 text-gray-500 font-semibold">ëª¨ë‘ ë³´ê¸°</button>
      </div>
    </div>
    <br>
  </div>

  <!-- ğŸ”¹ ë³´ìœ  ì•„ì´í…œ ì˜ì—­ -->

  <div id="item-section" class="mt-6 mb-20 transition-all duration-300 flex justify-center">
    <div class="grid grid-cols-2 md:grid-cols-4 gap-6 max-w-5xl">
      {% for ui in owned_items %}
        {% with path=ui.item.image_path %}
          {% if not 'clothes' in path %}
            <div class="item-card hidden inline-block text-center"
                data-character="{% if 'geulssung' in path %}geulssung{% elif 'malssung' in path %}malssung{% endif %}"
                data-category="{% if 'body' in path %}ëª¸ì²´{% elif 'bag' in path %}ê°€ë°©{% elif 'glass' in path %}ì•ˆê²½{% elif 'acc' in path %}ì•…ì„¸ì„œë¦¬{% elif 'head' in path %}ëª¨ì{% elif 'clothes' in path %}ì˜·{% else %}ê¸°íƒ€{% endif %}">
              <img src="{% static ui.item.image_path %}"
                  onclick="toggleEquip('{{ ui.item.id }}')"
                  class="w-52 h-52 rounded shadow cursor-pointer hover:scale-110 transition">
              <p class="text-xs mt-1">
                {% if ui.equipped %}
                  <span class="text-green-500">ì°©ìš© ì¤‘</span>
                {% else %}
                  <span class="text-gray-400">ë¯¸ì°©ìš©</span>
                {% endif %}
              </p>
            </div>
          {% endif %}
        {% endwith %}
      {% endfor %}
    </div>

      <!-- {# âœ… ì˜·(clothes) ì•„ì´í…œì€ ë§ˆì§€ë§‰ì— ì¶œë ¥ #}
      {% for ui in owned_items %}
        {% with path=ui.item.image_path %}
          {% if 'clothes' in path %}
            <div class="item-card hidden inline-block text-center"
                data-character="{% if 'geulssung' in path %}geulssung{% elif 'malssung' in path %}malssung{% endif %}"
                data-category="{% if 'body' in path %}ëª¸ì²´{% elif 'bag' in path %}ê°€ë°©{% elif 'glass' in path %}ì•ˆê²½{% elif 'acc' in path %}ì•…ì„¸ì„œë¦¬{% elif 'head' in path %}ëª¨ì{% elif 'clothes' in path %}ì˜·{% else %}ê¸°íƒ€{% endif %}">
              <img src="{% static ui.item.image_path %}"
                  onclick="toggleEquip('{{ ui.item.id }}')"
                  class="w-52 h-52 rounded shadow cursor-pointer hover:scale-110 transition">
              <p class="text-xs mt-1">
                {% if ui.equipped %}
                  <span class="text-green-500">ì°©ìš© ì¤‘</span>
                {% else %}
                  <span class="text-gray-400">ë¯¸ì°©ìš©</span>
                {% endif %}
              </p>
            </div>
          {% endif %}
        {% endwith %}
      {% endfor %} -->
  </div>

<script>
  let selectedCharacter = null;
  let selectedCategory = null;

  // ğŸ”¹ ì´ˆê¸° ì¥ì°© ì•„ì´í…œ mount
  const initialEquippedItems = [
    {% for ui in equipped_items %}
      {% with path=ui.item.image_path %}
        {% if ui.equipped %}
          {
            id: {{ ui.item.id }},
            image_path: "{% static ui.item.image_path %}",
            character: "{% if 'malssung' in path %}malssung{% else %}geulssung{% endif %}",
            part: "{% if 'body' in path %}body{% elif 'bag' in path %}bag{% elif 'glass' in path %}glass{% elif 'acc' in path %}acc{% elif 'clothes' in path %}clothes{% elif 'head' in path %}head{% endif %}"
          },
        {% endif %}
      {% endwith %}
    {% endfor %}
  ];

  window.addEventListener('DOMContentLoaded', () => {
    initialEquippedItems.forEach(item => {
      const target = document.querySelector(`.character-${item.character}`);
      const img = document.createElement('img');
      img.src = item.image_path;
      img.className = 'absolute top-0 left-0 w-full';
      img.setAttribute('data-part', item.part);
      img.style.zIndex = item.part === 'body' ? '10' : '20';
      const base = target.querySelector('img');
      if (item.part === 'body' && base && base.nextSibling) {
        target.insertBefore(img, base.nextSibling);
      } else {
        target.appendChild(img);
      }
    });
  });

  // ğŸ”¹ ìºë¦­í„° ì„ íƒ
  function selectCharacter(character) {
    selectedCharacter = character;
    selectedCategory = null;

    document.getElementById('geulssung-buttons').classList.toggle('hidden', character !== 'geulssung');
    document.getElementById('malssung-buttons').classList.toggle('hidden', character !== 'malssung');

    filterItems();
  }

  // ğŸ”¹ ë¶€ìœ„ ë²„íŠ¼ í´ë¦­ ì‹œ
  function activateButton(button, category) {
    selectedCategory = category;

    document.querySelectorAll(".category-btn").forEach(btn => {
      btn.classList.remove("bg-[#00C9A7]", "text-white");
      btn.classList.add("bg-gray-100", "text-gray-500");
    });

    button.classList.remove("bg-gray-100", "text-gray-500");
    button.classList.add("bg-[#00C9A7]", "text-white");

    filterItems();
  }

  // ğŸ”¹ ì•„ì´í…œ í•„í„°ë§
  function filterItems() {
    document.querySelectorAll(".item-card").forEach(card => {
      const matchChar = selectedCharacter === null || card.dataset.character === selectedCharacter;
      const matchCat = selectedCategory === null || card.dataset.category === selectedCategory;
      card.classList.toggle("hidden", !(matchChar && matchCat));
    });
  }

  // ğŸ”¹ ëª¨ë‘ ë³´ê¸°
  function showAllItems() {
    selectedCategory = null;
    document.querySelectorAll(".category-btn").forEach(btn => {
      btn.classList.remove("bg-[#00C9A7]", "text-white");
      btn.classList.add("bg-gray-100", "text-gray-500");
    });
    filterItems();
  }

  // ğŸ”¹ ì¥ì°©/í•´ì œ toggle
  function toggleEquip(itemId) {
    const clickedCard = document.querySelector(`[onclick="toggleEquip('${itemId}')"]`).closest('.item-card');
    const statusSpan = clickedCard.querySelector('p span');
    const isCurrentlyEquipped = statusSpan.innerText === 'ì°©ìš© ì¤‘';

    // ì„ ë°˜ì˜
    statusSpan.innerText = isCurrentlyEquipped ? 'ë¯¸ì°©ìš©' : 'ì°©ìš© ì¤‘';
    statusSpan.classList.toggle('text-green-500', !isCurrentlyEquipped);
    statusSpan.classList.toggle('text-gray-400', isCurrentlyEquipped);

    fetch(`/my-items/toggle-equip/${itemId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        updateItemStatus(itemId, data.equipped, data.image_path);
      } else {
        // ë¡¤ë°±
        statusSpan.innerText = isCurrentlyEquipped ? 'ì°©ìš© ì¤‘' : 'ë¯¸ì°©ìš©';
        statusSpan.classList.toggle('text-green-500', isCurrentlyEquipped);
        statusSpan.classList.toggle('text-gray-400', !isCurrentlyEquipped);
        alert("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    });
  }

  // ğŸ”¹ ì¥ì°© ìƒíƒœ ë°˜ì˜
  function updateItemStatus(itemId, equipped, imagePath) {
    const itemCard = document.querySelector(`[onclick="toggleEquip('${itemId}')"]`).closest('.item-card');
    const statusSpan = itemCard.querySelector('p span');

    const isMalssung = imagePath.includes('malssung');
    const targetContainerSelector = isMalssung ? '.character-malssung' : '.character-geulssung';
    const targetContainer = document.querySelector(targetContainerSelector);

    const partMatch = imagePath.match(/(body|bag|glass|acc|clothes|head)/);
    const part = partMatch ? partMatch[1] : null;
    const categoryKor = convertPartToKorean(part);
    const character = isMalssung ? 'malssung' : 'geulssung';

    // ê¸°ì¡´ ê°™ì€ ë¶€ìœ„ ì „ë¶€ ì œê±°
    const existingImgs = targetContainer.querySelectorAll(`img[data-part="${part}"]`);
    existingImgs.forEach(img => img.remove());

    // í…ìŠ¤íŠ¸ ì´ˆê¸°í™” (ê°™ì€ ë¶€ìœ„ ë‹¤ë¥¸ ì¹´ë“œë“¤)
    document.querySelectorAll(`.item-card[data-character="${character}"][data-category="${categoryKor}"]`).forEach(card => {
      const span = card.querySelector('p span');
      span.innerText = 'ë¯¸ì°©ìš©';
      span.classList.remove('text-green-500');
      span.classList.add('text-gray-400');
    });

    if (equipped) {
      // í…ìŠ¤íŠ¸ ë³€ê²½
      statusSpan.innerText = 'ì°©ìš© ì¤‘';
      statusSpan.classList.remove('text-gray-400');
      statusSpan.classList.add('text-green-500');

      // ì´ë¯¸ì§€ ì¶”ê°€
      const img = document.createElement('img');
      img.src = imagePath.startsWith('/static/') ? imagePath : '/static/' + imagePath;
      img.className = 'absolute top-0 left-0 w-full';
      img.setAttribute('data-part', part);
      img.style.zIndex = part === 'body' ? '10' : '20';

      // ì‚½ì…
      const baseImg = targetContainer.querySelector('img');
      if (part === 'body' && baseImg && baseImg.nextSibling) {
        targetContainer.insertBefore(img, baseImg.nextSibling);
      } else {
        targetContainer.appendChild(img);
      }
    }
  }

  function convertPartToKorean(part) {
    switch (part) {
      case 'body': return 'ëª¸ì²´';
      case 'bag': return 'ê°€ë°©';
      case 'glass': return 'ì•ˆê²½';
      case 'acc': return 'ì•…ì„¸ì„œë¦¬';
      case 'clothes': return 'ì˜·';
      case 'head': return 'ëª¨ì';
      default: return '';
    }
  }
</script>
  
</body>
</html>