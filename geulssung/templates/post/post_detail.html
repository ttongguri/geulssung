{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>{{ post.title }} - ê¸€ì½ê¸€ì½</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Gowun+Batang&family=Gaegu:wght@700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Gowun Batang', serif; background-color: #FFF9F2; color: #493E3E; }
    .gaegu{ font-family: 'Gaegu', cursive; }
    .rounded-xl { border-radius: 1rem !important; }
    .shadow-xl { box-shadow: 0 8px 24px 0 rgba(73,62,62,0.08), 0 1.5px 4px 0 rgba(73,62,62,0.08) !important; }
    .card {
      background: #fff;
      border-radius: 1rem;
      box-shadow: 0 8px 24px 0 rgba(73,62,62,0.08), 0 1.5px 4px 0 rgba(73,62,62,0.08);
      padding: 2rem;
      margin-bottom: 2rem;
    }
    .card-title {
      font-weight: bold;
      font-size: 2rem;
      color: #493E3E;
    }
    .card-meta {
      color: #8d7b68;
      font-size: 1rem;
    }
    .blurred-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-image: url('{% static "images/ë°”ë‹¤ë§Œ ë©ê·¸ëŸ¬ë‹ˆ2.png" %}');
      background-size: cover;
      background-position: center;
      filter: blur(4px) brightness(0.95);
      z-index: -10;
    }
  </style>
</head>
<body class="bg-[#FFF9F2] min-h-screen p-8 relative">
  <div class="blurred-bg"></div>
  <!-- í—¤ë” ì˜¤ë¥¸ìª½ ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
  <div class="absolute top-6 right-8 text-sm space-x-4">
    {% if user.is_authenticated %}
      <span class="text-[#493E3E] font-semibold">{{ user.nickname }}ë‹˜</span>
      <a href="{% url 'logout' %}" class="text-[#493E3E] underline hover:text-gray-600">ë¡œê·¸ì•„ì›ƒ</a>
    {% else %}
      <a href="{% url 'login' %}" class="text-[#493E3E] underline hover:text-gray-600">ë¡œê·¸ì¸</a>
      <a href="{% url 'signup' %}" class="text-[#493E3E] underline hover:text-gray-600">íšŒì›ê°€ì…</a>
    {% endif %}
  </div>

  <!-- ìƒì„¸ë³´ê¸° ì„¹ì…˜ -->
  <div id="detail-content" class="max-w-3xl mx-auto card mt-16 relative">
    <!-- ì¥ë¥´(í•œê¸€) ë° ì£¼ì œ -->
    <p class="text-sm text-gray-600 mb-4">
      {% if post.genre == 'poem' %}
      ì‹œ
      {% elif post.genre == 'column' %}
      ì»¬ëŸ¼
      {% elif post.genre == 'essay' %}
      ì—ì„¸ì´
      {% elif post.genre == 'analysis' %}
      ë¶„ì„ê¸€
      {% else %}
        {{post.genre}}
      {% endif %}
      {# | {{ post.topic }} #}
    </p>

    <!-- ì œëª© -->
    <div class="flex items-center justify-between mb-2">
      <h1 class="card-title">{{ post.title }}</h1>
      {% if user.is_authenticated and user != post.author %}
        <button type="button"
                id="like-btn"
                class="like-btn text-red-400 hover:text-red-600 text-2xl font-bold transition flex items-center gap-1 ml-4"
                data-post-id="{{ post.id }}">
          {% if user in post.like_users.all %}
            <span class="heart">â¤ï¸</span><span class="like-count text-sm align-middle">({{ post.like_users.count }})</span>
          {% else %}
            <span class="heart">ğŸ¤</span><span class="like-count text-sm align-middle">({{ post.like_users.count }})</span>
          {% endif %}
        </button>
      {% elif user == post.author %}
        <span class="text-red-400 text-2xl font-bold flex items-center gap-1 ml-4">
          <span class="heart">â¤ï¸</span>
          <span class="like-count text-sm align-middle">({{ post.like_users.count }})</span>
        </span>
      {% endif %}
    </div>

    <!-- ì‘ì„±ì ë° ì‘ì„±ì¼ -->
    <p class="text-sm text-gray-600 mb-6">by {{ post.author.nickname }} | {{ post.created_at|date:"Y.m.d H:i" }}</p>
    {# <div class="mb-4"><span class="font-semibold">ê¸€ê°:</span> {{ post.topic }}</div> #}
    <div class="mb-4"><span class="font-semibold">ê¸€ê°:</span> {{ post.prompt.content|default:"-" }}</div>

    <!-- ìŠ¤í… ì „ì²´ í† ê¸€ ë²„íŠ¼ -->
    <button onclick="toggleSteps()"
        class="mb-6 px-4 py-2 bg-[#F9DCC4] hover:bg-[#f7cbaa] text-[#493E3E] rounded-full font-bold transition">
      ğŸ’§ê¸€ë°©ìš¸ ëª¨ì•„ë³´ê¸°
    </button>

    <!-- ì»¤ë²„ ì´ë¯¸ì§€ -->
    {% if post.cover_image %}
      <img src="{{ post.cover_image.url }}" alt="ì»¤ë²„ ì´ë¯¸ì§€" class="w-full h-auto mb-6 rounded-lg">
    {% endif %}

    <!-- Step1~3 ì„¹ì…˜ (ê¸°ë³¸ ìˆ¨ê¹€) -->
    <div id="steps-section" class="prose hidden">
      <p class="font-bold text-lg mt-4">Step 1</p>
      <p class="mt-1">{{ post.step1 }}</p>

      <p class="font-bold text-lg mt-6">Step 2</p>
      <p class="mt-1">{{ post.step2 }}</p>

      <p class="font-bold text-lg mt-6">Step 3</p>
      <p class="mt-1">{{ post.step3 }}</p>
    </div>
    <br>
    <hr>

    <!-- ìµœì¢… ê¸€ ë‚´ìš© -->
    <div class="prose mt-8" style="color:#493E3E;">
      <p class="font-bold text-xl">ğŸ§© ê¸€ì¤„ê¸°</p>
      <p class="mt-2">{{ post.final_content|linebreaks }}</p>
    </div>
    <br>
    <hr>
    <div class="flex justify-center mt-6 space-x-4">
      <a href="{% url 'home' %}"
        class="px-5 py-2 bg-[#F9DCC4] hover:bg-[#f7cbaa] text-[#493E3E] rounded-full font-bold transition">
        í™ˆìœ¼ë¡œğŸ 
      </a>
      <a href="{% url 'public_user_posts' post.author.nickname %}"
        class="px-5 py-2 bg-[#F9DCC4] hover:bg-[#f7cbaa] text-[#493E3E] rounded-full font-bold transition">
        {{ post.author.nickname }}ë‹˜ì˜ ê¸€ìêµ­ğŸ¾
      </a>
      <a href="{% url 'explore' %}"
        class="px-5 py-2 bg-[#F9DCC4] hover:bg-[#f7cbaa] text-[#493E3E] rounded-full font-bold transition">
        ê¸€ë°”ë‹¤ğŸŒŠ
      </a>
    </div>
    {% if user.is_authenticated and user == post.author %}
      <!-- ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
      <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-xl text-center">
          <h2 class="text-2xl font-bold mb-6 text-[#493E3E]">ì •ë§ë¡œ ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h2>
          <p class="mb-8 text-gray-700">ì‚­ì œí•˜ë©´ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
          <form id="deleteForm" method="post" action="{% url 'delete_post' post.id %}">
            {% csrf_token %}
            <button type="submit" class="px-6 py-3 bg-red-400 hover:bg-red-600 text-white font-bold rounded-full shadow-lg transition">ì‚­ì œ</button>
            <button type="button" onclick="closeDeleteModal()" class="ml-4 px-6 py-3 bg-gray-200 hover:bg-gray-300 text-[#493E3E] font-bold rounded-full transition">ì·¨ì†Œ</button>
          </form>
        </div>
      </div>
      <script>
        function openDeleteModal() {
          document.getElementById('deleteModal').classList.remove('hidden');
        }
        function closeDeleteModal() {
          document.getElementById('deleteModal').classList.add('hidden');
        }
      </script>
    {% endif %}

    <!-- ìˆ˜ì • ì„¹ì…˜ (ìˆ¨ê¹€) -->
    <div id="edit-section" class="hidden max-w-3xl mx-auto bg-white p-6 rounded-xl shadow mt-16">
      <form method="post">
        {% csrf_token %}
        <div class="mb-8 mt-8">
          <p class="font-bold text-[#493E3E] text-lg mb-2">ğŸ§© ê¸€ì¤„ê¸°: í•˜ë‚˜ì˜ ê¸€ë¡œ ì™„ì„±í•´ë³´ì„¸ìš”</p>
          <p class="text-sm text-gray-700 mb-3">
            ìœ„ ë‹¨ê³„ë³„ ì‘ì„± ë‚´ìš©ì„ ì°¸ê³ í•˜ì—¬, ë‹¹ì‹ ì˜ ìƒê°ì„ í•˜ë‚˜ì˜ íë¦„ ìˆëŠ” ê¸€ë¡œ ì •ë¦¬í•´ë³´ì„¸ìš”.<br />
            ì´ ê¸€ì€ ì‹¤ì œ ì œì¶œ ë° ê³µê°œ ê¸€ë¡œ ì‚¬ìš©ë  ìˆ˜ ìˆì–´ìš” âœï¸
          </p>
          <textarea name="final_text" rows="10" class="w-full border px-4 py-3 rounded-md shadow-sm" required>{{ post.final_content }}</textarea>
        </div>
        <div class="flex justify-between mt-4">
          <button type="button" id="prev-btn" class="bg-gray-200 px-4 py-2 rounded-full">â† ì´ì „</button>
          <button type="submit" class="bg-[#F9DCC4] hover:bg-[#f7cbaa] text-[#493E3E] font-bold px-6 py-3 rounded-full transition">
            ì œì¶œí•˜ê¸°
          </button>
        </div>
      </form>
    </div>

    <!-- í™ˆ/ê¸€ìêµ­/ê¸€ë°”ë‹¤ ë²„íŠ¼ -->
    <div class="flex items-center mt-4">
      <!-- ì¢Œì¸¡/ê°€ìš´ë° ë¹„ì›€ -->
      <div class="flex-1"></div>
      <div class="flex-1"></div>
      <!-- ìš°ì¸¡: ë°œí–‰/ë°œí–‰ì·¨ì†Œ, ì‚­ì œ -->
      <div class="flex-1 flex justify-end space-x-2">
        {% if user == post.author %}
          <div class="absolute top-6 right-8 z-20 flex space-x-2">
            <form method="post" action="{% url 'toggle_post_visibility' post.id %}" class="inline">
              {% csrf_token %}
              {% if not post.is_public %}
                <input type="hidden" name="visibility" value="public">
                <button type="submit"
                        class="px-5 py-2 bg-[#F9DCC4] hover:bg-[#f7cbaa] text-[#493E3E] rounded-full font-bold text-sm transition">
                  ë°œí–‰
                </button>
              {% else %}
                <input type="hidden" name="visibility" value="private">
                <button type="submit"
                        class="px-5 py-2 bg-gray-300 hover:bg-gray-400 text-[#493E3E] rounded-full font-bold text-sm transition">
                  ë°œí–‰ì·¨ì†Œ
                </button>
              {% endif %}
            </form>
            <button type="button" onclick="openDeleteModal()" class="px-5 py-2 bg-red-400 hover:bg-red-600 text-white font-bold rounded-full shadow text-sm transition">
              ì‚­ì œ
            </button>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <script>
    // ìŠ¤í… í† ê¸€ í•¨ìˆ˜
    function toggleSteps() {
      const section = document.getElementById('steps-section');
      section.classList.toggle('hidden');
      if (!section.classList.contains('hidden')) {
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }

    // ê³µê°œ/ë¹„ê³µê°œ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
    document.querySelectorAll('input[name="visibility"]').forEach(input => {
      input.addEventListener('change', () => {
        const msg = document.getElementById('visibility-message');
        msg.textContent = input.value === 'public'
          ? 'ì´ ê¸€ì€ ê³µê°œë©ë‹ˆë‹¤.'
          : 'ì´ ê¸€ì€ ë‚˜ë§Œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
      });
    });

    const likeBtn = document.getElementById('like-btn');
    if (likeBtn) {
      likeBtn.addEventListener('click', async function () {
        const postId = this.dataset.postId;
        const response = await fetch("{% url 'like' post.id %}", {
          method: "POST",
          headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "X-Requested-With": "XMLHttpRequest"
          }
        });
        const data = await response.json();
        if (data.status === 'liked') {
          this.querySelector('.heart').textContent = 'â¤ï¸';
        } else if (data.status === 'unliked') {
          this.querySelector('.heart').textContent = 'ğŸ¤';
        }
        this.querySelector('.like-count').textContent = `(${data.count})`;
      });
    }
  </script>
</body>
</html>
