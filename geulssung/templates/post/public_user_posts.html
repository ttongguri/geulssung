{% load static %}
<!DOCTYPE html>
<html lang="ko" style="font-size: 80%;">
<head>
  <meta charset="UTF-8" />
  <title>{{ author.nickname }}ë‹˜ì˜ ê¸€ìêµ­ğŸ¾</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- í•œê¸€ í°íŠ¸ ì ìš© -->
  <link href="https://fonts.googleapis.com/css2?family=Gowun+Batang&display=swap" rel="stylesheet">

  <style>
    /* ======================== ê³µí†µ ìŠ¤íƒ€ì¼ ======================== */

    body {
      font-family: 'Gowun Batang', serif;
      background-color: #FFF9F2;
      color: #493E3E;
    }

    .rounded-xl { border-radius: 1rem !important; }
    .shadow-xl { box-shadow: 0 8px 24px 0 rgba(73,62,62,0.08), 0 1.5px 4px 0 rgba(73,62,62,0.08) !important; }

    /* ì¹´ë“œ ì»´í¬ë„ŒíŠ¸ */
    .card {
      background: #fff;
      border-radius: 1rem;
      box-shadow: 0 8px 24px 0 rgba(73,62,62,0.08), 0 1.5px 4px 0 rgba(73,62,62,0.08);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .card-title {
      font-weight: bold;
      font-size: 1.25rem;
      color: #493E3E;
    }

    .card-meta {
      color: #8d7b68;
      font-size: 0.95rem;
    }

    /* ì¢‹ì•„ìš” í´ë¦­ ì‹œ ì• ë‹ˆë©”ì´ì…˜ */
    .like-float {
      position: absolute;
      font-size: 1rem;
      font-weight: bold;
      color: #f87171;
      animation: fadeUp 0.8s ease-out forwards;
      pointer-events: none;
      z-index: 10;
    }

    @keyframes fadeUp {
      0% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-20px); }
    }

    /* ======================== íˆíŠ¸ë§µ ìŠ¤íƒ€ì¼ ======================== */

    /* ë°˜ì‘í˜• ë³€ìˆ˜ */
    :root {
      --cell-size: 15px;
      --cell-gap: 3.5px;
    }

    @media (max-width: 1023px) {
      :root {
        --cell-size: 12px;
        --cell-gap: 1.5px;
      }
    }

    @media (max-width: 767px) {
      :root {
        --cell-size: 9px;
        --cell-gap: 1px;
      }
    }

    /* íˆíŠ¸ë§µ ë ˆì´ì•„ì›ƒ */
    .heatmap-wrapper {
      display: flex;
      flex-direction: row;
      align-items: flex-start;
    }

    .heatmap-week-labels {
      display: flex;
      flex-direction: column;
      gap: 0.05px;
      margin-right: 8px;
      font-size: 12px;
      color: #555;
      height: calc(var(--cell-size) * 7 + var(--cell-gap) * 6);
    }

    /* ë°˜ì‘í˜• ê¸€ì í¬ê¸° */
    @media (max-width: 1023px) {
      .heatmap-week-labels {
        font-size: 11px;
      }
    }

    @media (max-width: 767px) {
      .heatmap-week-labels {
        font-size: 10px;
      }
    }

    .heatmap-month-labels {
      display: grid;
      grid-template-columns: repeat(52, calc(var(--cell-size) + var(--cell-gap)));
      column-gap: 0.1px;
      margin-bottom: 4px;
      margin-left: 32px;
      font-size: 12px;
      color: #555;
    }

    /* ë°˜ì‘í˜• font-size */
    @media (max-width: 1023px) {
      .heatmap-month-labels {
        font-size: 11px;
      }
    }

    @media (max-width: 767px) {
      .heatmap-month-labels {
        font-size: 10px;
      }
    }

    .heatmap-month-labels div {
      text-align: center;
      line-height: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .heatmap-grid {
      display: grid;
      grid-template-rows: repeat(7, var(--cell-size));
      grid-auto-flow: column;
      gap: var(--cell-gap);
    }

    .heatmap-cell {
      width: var(--cell-size);
      height: var(--cell-size);
      background: #ededed;
      border-radius: calc(var(--cell-size) / 4);
      cursor: pointer;
      position: relative;
    }

    /* ì»¤ìŠ¤í…€ Tooltip */
    .heatmap-cell::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      background-color: #333;
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      z-index: 10;
    }

    .heatmap-cell:hover::after {
      opacity: 1;
    }
  </style>
</head>

<body class="bg-[#f0f9ff] min-h-screen text-[#493E3E] p-10" style="font-family: 'Gowun Batang', serif;">

  {% include "nav_bar.html" %}

  <!-- ìƒë‹¨ íŒ¨ë”© -->
  <div class="h-14"></div>

  <!-- ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ -->
  <div class="max-w-6xl mx-auto mt-8">

    <!-- í˜ì´ì§€ ì œëª© -->
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold mb-6">{{ author.nickname }}ë‹˜ì˜ ê¸€ìêµ­ğŸ¾</h1>

      <!-- ê²€ìƒ‰ í¼ -->
      <form method="get" action="" class="mb-6 flex">
        <input type="text" name="q" placeholder="ì œëª© ë˜ëŠ” ë‚´ìš© ê²€ìƒ‰" value="{{ q }}" class="text-sm border rounded-l px-3 py-2 w-56" />
        <button type="submit" class="text-sm bg-blue-500 text-white px-4 py-2 rounded-r">ê²€ìƒ‰</button>
      </form>
    </div>

    <!-- Fê¸€/Tê¸€ ë¹„ìœ¨ ë§‰ëŒ€ ê·¸ë˜í”„ -->
    {% if total_count > 0 %}
    <div class="w-full max-w-6xl mx-auto mb-10 flex items-center">
      <!-- ê¸€ì½ì´ ìºë¦­í„° -->
      <div class="flex-shrink-0 w-64 h-64">
        {% include "customizing/character_render.html" with character=geulssung_character equipped_items=geulssung_equipped_items %}
      </div>

      <!-- ë¹„ìœ¨ ê·¸ë˜í”„ -->
      <div class="flex-1 mx-8">
        <div class="flex justify-between text-lg md:text-2xl font-semibold mb-4">
          <span class="text-blue-600">Fê¸€(ê°ì„±) {{ f_count }}ê°œ ({{ f_ratio }}%)</span>
          <span class="text-orange-500">Tê¸€(ë…¼ë¦¬) {{ t_count }}ê°œ ({{ t_ratio }}%)</span>
        </div>
        <div class="w-full h-12 bg-gray-200 rounded-full overflow-hidden flex">
          <div class="h-full bg-blue-400" style="width: {{ f_ratio }}%"></div>
          <div class="h-full bg-orange-400" style="width: {{ t_ratio }}%"></div>
        </div>
      </div>

      <!-- ë§ì½ì´ ìºë¦­í„° -->
      <div class="flex-shrink-0 w-64 h-64">
        {% include "customizing/character_render.html" with character=malssung_character equipped_items=malssung_equipped_items %}
      </div>
    </div>
    {% endif %}

    <!-- êµ¬ë…(íŒ”ë¡œìš°) ë²„íŠ¼ -->
    {% if user.is_authenticated and user.id != author.id %}
      <div class="mb-6">
        <button id="follow-btn"
                data-user-id="{{ author.id }}"
                class="px-4 py-2 font-bold rounded-full shadow transition
                       {% if is_following %} bg-red-300 hover:bg-red-400
                       {% else %} bg-blue-300 hover:bg-blue-400 {% endif %}">
          {% if is_following %} ì–¸íŒ”ë¡œìš° {% else %} êµ¬ë… {% endif %}
        </button>
      </div>
    {% endif %}

    <!-- íˆíŠ¸ë§µ ì›” ë ˆì´ë¸” -->
    <div class="heatmap-month-labels" id="month-labels"></div>

    <!-- íˆíŠ¸ë§µ ë³¸ì²´ -->
    <div class="heatmap-wrapper">
      <!-- ìš”ì¼ ë ˆì´ë¸” -->
      <div class="heatmap-week-labels mb-10">
        <div>ì›”</div><div>í™”</div><div>ìˆ˜</div>
        <div>ëª©</div><div>ê¸ˆ</div><div>í† </div><div>ì¼</div>
      </div>

      <!-- íˆíŠ¸ë§µ ì…€ -->
      <div id="heatmap" class="heatmap-grid"></div>
    </div>

    <!-- í¬ìŠ¤íŠ¸ ë¦¬ìŠ¤íŠ¸ -->
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
      {% for post in posts %}
        <div class="relative card overflow-hidden">

          <!-- ì»¤ë²„ ì´ë¯¸ì§€ -->
          <a href="{% url 'post_detail' post_id=post.id %}">
            {% if post.postimage %}
              <img src="{{ post.postimage.image.url }}" alt="ì»¤ë²„ ì´ë¯¸ì§€" class="w-full aspect-square object-cover rounded-xl border-b" />
            {% else %}
              <img src="{% static 'images/í”¼ê·¸ë¯¼.png' %}" alt="ê¸°ë³¸ ì´ë¯¸ì§€" class="w-full aspect-square object-cover rounded-xl border-b" />
            {% endif %}
          </a>

          <!-- ì¢‹ì•„ìš” ë²„íŠ¼ -->
          <div class="flex justify-between items-center mt-2 mb-1">
            <div>
              {% if user.is_authenticated %}
                {% if user == post.author %}
                  <div class="like-btn text-red-400 text-2xl font-bold flex items-center gap-1 pointer-events-none">
                    <span class="heart">â¤ï¸</span><span class="like-count text-sm align-middle">({{ post.like_users.count }})</span>
                  </div>
                {% else %}
                  <button type="button" class="like-btn text-red-400 hover:text-red-600 text-2xl font-bold transition flex items-center gap-1" data-post-id="{{ post.id }}">
                    {% if user in post.like_users.all %}
                      <span class="heart">â¤ï¸</span><span class="like-count text-sm align-middle">({{ post.like_users.count }})</span>
                    {% else %}
                      <span class="heart">ğŸ¤</span><span class="like-count text-sm align-middle">({{ post.like_users.count }})</span>
                    {% endif %}
                  </button>
                {% endif %}
              {% endif %}
            </div>

            <!-- ì»¤ë²„ ì‚¬ì§„ ë³€ê²½ ë²„íŠ¼ (ë³¸ì¸ë§Œ í‘œì‹œ) -->
            {% if user.is_authenticated and user == post.author %}
              <div class="flex flex-col items-start gap-0.5">
                <form method="post" action="{% url 'update_cover_image' post.id %}" enctype="multipart/form-data" class="flex items-center gap-2">
                  {% csrf_token %}
                  <input type="file" id="coverImageInput-{{ post.id }}" name="cover_image" accept="image/*" class="hidden" onchange="this.form.submit()" />
                  <button type="button" onclick="document.getElementById('coverImageInput-{{ post.id }}').click();" class="bg-[#bae6fd] text-black text-xs px-3 py-1 rounded-full shadow border border-[#7dd3fc] hover:bg-[#7dd3fc] hover:text-black transition-all">
                    ì»¤ë²„ ì‚¬ì§„ ë³€ê²½ğŸ“·
                  </button>
                </form>
              </div>
            {% endif %}
          </div>

          <!-- ì œëª© -->
          <h2 class="card-title truncate text-left mb-2">{{ post.title }}</h2>

          <!-- ì‘ì„±ì¼ -->
          <div class="flex justify-end">
            <div class="text-xs text-gray-400 mb-0.5 mr-0.5">ì‘ì„±ì¼: {{ post.created_at|date:"y.m.d" }}</div>
          </div>

          <!-- ë©”íƒ€ ì •ë³´ -->
          <div class="pt-2">
            <div class="flex justify-between items-center mt-3 text-sm card-meta">
              <span>
                {% if post.genre == 'poem' %}#ì‹œ
                {% elif post.genre == 'essay' %}#ì—ì„¸ì´
                {% elif post.genre == 'column' %}#ì¹¼ëŸ¼
                {% elif post.genre == 'analysis' %}#ë¶„ì„ê¸€
                {% else %}#{{ post.genre }}
                {% endif %}
              </span>
              <span class="italic">by {{ post.author.nickname }}</span>
            </div>
          </div>

        </div>
      {% empty %}
        <p class="text-gray-500 col-span-full text-center">ì•„ì§ ì‘ì„±ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
      {% endfor %}
    </div>

  </div>

  <!-- follow ë²„íŠ¼ ë™ì‘ -->
  <script>
    const followBtn = document.getElementById('follow-btn');
    if (followBtn) {
      followBtn.addEventListener('click', async function () {
        const userId = this.dataset.userId;
        const response = await fetch("/geulssung/accounts/follow/", {
          method: "POST",
          headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: `user_id=${userId}`,
        });
        const result = await response.json();
        if (result.status === 'followed' || result.status === 'unfollowed') {
          location.reload();
        }
      });
    }
  </script>

  <!-- like ë²„íŠ¼ ë™ì‘ + ì• ë‹ˆë©”ì´ì…˜ -->
  <script>
    document.querySelectorAll('.like-btn').forEach(btn => {
      btn.addEventListener('click', async function () {
        const postId = this.dataset.postId;
        const response = await fetch("{% url 'like' 0 %}".replace('0', postId), {
          method: "POST",
          headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "X-Requested-With": "XMLHttpRequest"
          }
        });
        const data = await response.json();

        const heart = this.querySelector('.heart');
        const count = this.querySelector('.like-count');

        const float = document.createElement('div');
        float.classList.add('like-float');
        float.textContent = data.status === 'liked' ? '+1' : '-1';

        const rect = this.getBoundingClientRect();
        float.style.left = `${this.offsetLeft + 20}px`;
        float.style.top = `${this.offsetTop - 10}px`;

        this.parentElement.appendChild(float);

        setTimeout(() => {
          float.remove();
        }, 800);

        heart.textContent = data.status === 'liked' ? 'â¤ï¸' : 'ğŸ¤';
        count.textContent = `(${data.count})`;
      });
    });
  </script>

  <!-- heatmap ê·¸ë¦¬ê¸° ìŠ¤í¬ë¦½íŠ¸ -->
<!-- heatmap ê·¸ë¦¬ê¸° ìŠ¤í¬ë¦½íŠ¸ -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const dataMap = {{ heatmap_data|safe }};
      const heatmap = document.getElementById('heatmap');
      const monthLabels = document.getElementById('month-labels');

      let startDate = new Date("{{ earliest_date }}");
      startDate.setDate(1);

      let endDate = new Date(startDate);
      endDate.setFullYear(endDate.getFullYear() + 1);
      endDate.setMonth(endDate.getMonth(), 0);

      // startdate ì›”ìš”ì¼ë¶€í„° ì‹œì‘ë˜ê²Œ (íˆíŠ¸ë§µ)
      const day = startDate.getDay();
      const diffToMonday = (day === 0 ? -6 : 1) - day;
      startDate.setDate(startDate.getDate() + diffToMonday);

      const getColor = cnt => {
        if (cnt >= 7) return '#c62828';
        if (cnt >= 5) return '#ef5350';
        if (cnt >= 3) return '#ef9a9a';
        if (cnt >= 1) return '#ffcdd2';
        return '#ededed';
      };

      let d = new Date(startDate);
      let currentMonth = -1;
      let weekIndex = 0;
      const monthSpans = [];
      let monthStartWeek = weekIndex;

      while (d <= endDate) {
        // ì£¼ ì‹œì‘ì¼ ì›”ìš”ì¼ ê¸°ì¤€
        if (d.getDay() === 1) {
          const month = d.getMonth();

          if (month !== currentMonth) {
            // ì´ì „ ì›” span width ê³„ì‚°
            if (currentMonth !== -1) {
              const span = monthSpans[monthSpans.length - 1];
              const weekSpan = weekIndex - monthStartWeek;
              span.style.gridColumn = `span ${weekSpan}`;
            }

            // ìƒˆ ì›” ë ˆì´ë¸” ì¶”ê°€ (ëª¨ë“  ì›” í‘œì‹œ)
            const label = document.createElement('div');
            label.textContent = `${month + 1}ì›”`; // ìˆ«ì + 'ì›”' í‘œì‹œ

            // ì¤‘ì•™ ì •ë ¬ ì ìš©
            label.style.gridColumn = 'span 1';
            label.style.justifySelf = 'center';

            monthLabels.appendChild(label);
            monthSpans.push(label);

            currentMonth = month;
            monthStartWeek = weekIndex;
          }

          weekIndex++;
        }

        // heatmap cell ìƒì„±
        for (let i = 0; i < 7; i++) {
          if (d > endDate) break;
          const iso = d.toISOString().slice(0,10);
          const cnt = dataMap[iso] || 0;

          const cell = document.createElement('div');
          cell.className = 'heatmap-cell';
          cell.style.background = getColor(cnt);
          cell.setAttribute('data-tooltip', `${iso}: ${cnt}ê°œ`);

          heatmap.appendChild(cell);

          d.setDate(d.getDate() + 1);
        }
      }

      // ë§ˆì§€ë§‰ ì›” span width ê³„ì‚°
      if (currentMonth !== -1 && monthSpans.length > 0) {
        const span = monthSpans[monthSpans.length - 1];
        const weekSpan = weekIndex - monthStartWeek;
        span.style.gridColumn = `span ${weekSpan}`;
      }
    });
  </script>
</body>
</html>
