{% load static %}
<!DOCTYPE html>
<html lang="ko" style="font-size: 80%;">
<head>
  <meta charset="UTF-8">
  <title>ê¸€ì“°ê¸° âœï¸</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Gowun+Batang&display=swap');
    body { font-family: 'Gowun Batang', serif; }
    .guide-toggle summary {
      font-weight: bold;
      cursor: pointer;
      color: #493E3E;
      margin-bottom: 0.5rem;
    }
    .guide-toggle {
      margin-bottom: 1rem;
      border: 1px solid #ccc;
      border-radius: 0.5rem;
      padding: 0.5rem;
      background-color: #fff;
    }
  </style>
</head>

<body class="bg-[#bae6fd] min-h-screen text-[#493E3E] p-10" style="font-family: 'Gowun Batang', serif;">
  <style>
    .background{
      background-image: url('{% static "images/ìˆ˜ì •.png" %}'); 
      background-size: cover; 
      background-position: center; 
      background-repeat: no-repeat;
    }
  </style>
  {% include "nav_bar.html" %}

<form method="post" action="" enctype="multipart/form-data">
  {% csrf_token %}
  <!-- ì „ì²´ ë˜í¼ -->
  <div class="bg-white w-[1100px] min-h-[600px] ml-[auto] mr-[26rem] mt-20 rounded-xl shadow-lg overflow-hidden flex">
    
      <!-- ì™¼ìª½: ê°€ì´ë“œ ì‚¬ì´ë“œë°” -->
      <aside id="guide-sidebar"
            class="w-[480px] border-r border-gray-200 flex flex-col">
        <!-- í—¤ë” -->
        <div class="sticky top-0 bg-white z-10 px-6 py-4 border-b">
          <p class="text-xl font-bold text-[#493E3E]">âœï¸ ê¸€ì“°ê¸° ê°€ì´ë“œ</p>
          <p class="text-sm text-gray-600">ì¥ë¥´ ì„ íƒ ì‹œ ì—¬ê¸°ì— ê°€ì´ë“œê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</p>
          <div class="text-right mt-2">
            <button type="button" onclick="resetGuideSteps()"
                    class="text-sm text-red-500 hover:text-red-700 border border-red-300 px-3 py-1 rounded-full transition">
              ğŸ”„ ê°€ì´ë“œ ì´ˆê¸°í™” í•˜ê¸°
            </button>
          </div>
        </div>

        <!-- ìŠ¤í¬ë¡¤ ì˜ì—­ -->
        <div id="guide-scrollable"
            class="flex-1 overflow-y-auto px-6 py-4">
          <!-- ì„ íƒí•œ ê¸€ê° í‘œì‹œ ì˜ì—­ -->
          <div id="selected-prompt-display" class="mb-4 p-4 bg-[#f0f9ff] rounded text-sm text-[#0c4a6e] font-semibold hidden">
            <div>ì„ íƒí•œ í˜•ì‹: <span id="selected-genre-text"></span></div>
            <div>ì„ íƒí•œ ê¸€ê°: <span id="selected-prompt-text"></span></div>
          </div>
          <!-- ê°€ì´ë“œ ì½˜í…ì¸  ì‚½ì… -->
        </div>
      </aside>
    
      <!-- ì˜¤ë¥¸ìª½: ê¸€ì“°ê¸° ë©”ì¸ -->
      <main id="writing-area"
            class="flex-1 p-6 overflow-y-auto">
        <div class="flex justify-end gap-2 mb-4">
          <!-- âœ… ì €ì¥ | 3 ë²„íŠ¼: ì§ì‚¬ê°í˜• ë°•ìŠ¤ -->
          <div class="flex items-center gap-1 px-4 py-2 border border-gray-300 rounded-md shadow-sm bg-white text-sm">
            <button type="button" onclick="handleTemporarySave()" class="text-[#493E3E] hover:underline">
              ì €ì¥
            </button>
            <span class="text-gray-300">|</span>
            <button type="button" onclick="openDraftModal()" class="text-green-600 font-semibold hover:underline">
              <span id="draftCount">0</span>
            </button>
          </div>

          <!-- âœ… ê°€ì´ë“œ ì ‘ê¸° ë²„íŠ¼ (ê·¸ëŒ€ë¡œ ìœ ì§€) -->
          <button id="toggleGuideBtn"
                  onclick="toggleGuide()"
                  class="bg-[#fde68a] text-black px-4 py-2 rounded-full text-sm shadow">
            ğŸ“š ê°€ì´ë“œ ì ‘ê¸°
          </button>
        </div>

        
        <div class="h-full flex flex-col">
          <input type="hidden" name="character" id="character-input" value="none">
          <input type="hidden" name="custom_prompt" id="customPromptHidden">
    
          <div id="step-1" class="step-form flex-1">
            <div class="mb-6">
              <p class="font-semibold text-[#493E3E] mb-2">ì˜¤ëŠ˜ì˜ ê¸€ì“°ê¸° ë„ìš°ë¯¸ë¥¼ ì„ íƒí•´ë³´ì„¸ìš”!</p>
              <div class="flex gap-4">
                <input type="radio" name="category" value="emotion" id="emotion" class="hidden peer/emotion" onchange="handleCharacterSelection(this.value)">
                <label for="emotion"
                  class="bg-white text-[#493E3E] px-4 py-2 rounded-full border border-gray-300 font-semibold cursor-pointer transition 
                        peer-checked/emotion:bg-[#00C9A7] peer-checked/emotion:text-white">
                  F ê°ì„±ì˜ ê¸€ì½ì´
                </label>

                <input type="radio" name="category" value="logic" id="logic" class="hidden peer/logic" onchange="handleCharacterSelection(this.value)">
                <label for="logic"
                  class="bg-white text-[#493E3E] px-4 py-2 rounded-full border border-gray-300 font-semibold cursor-pointer transition 
                        peer-checked/logic:bg-[#00C9A7] peer-checked/logic:text-white">
                  T ê°ì„±ì˜ ë§ì½ì´
                </label>
              </div>
            </div>

            <div class="mb-6" id="genre-emotion" style="display:none;">
              <p class="font-semibold text-[#493E3E] mb-2">í˜•ì‹ì„ ê³¨ë¼ë³´ì„¸ìš” (ê¸€ì½ì´)</p>
              <div class="flex gap-4">
                <input type="radio" name="genre" value="essay" id="essay" class="hidden peer/essay" onchange="showGuide(this.value)">
                <label for="essay"
                  class="bg-white text-[#493E3E] px-4 py-2 rounded-full border border-gray-300 font-semibold cursor-pointer transition
                        peer-checked/essay:bg-[#00C9A7] peer-checked/essay:text-white">
                  ì—ì„¸ì´
                </label>

                <input type="radio" name="genre" value="poem" id="poem" class="hidden peer/poem" onchange="showGuide(this.value)">
                <label for="poem"
                  class="bg-white text-[#493E3E] px-4 py-2 rounded-full border border-gray-300 font-semibold cursor-pointer transition
                        peer-checked/poem:bg-[#00C9A7] peer-checked/poem:text-white">
                  ì‹œ
                </label>
              </div>
            </div>

            <div class="mb-6" id="genre-logic" style="display:none;">
              <p class="font-semibold text-[#493E3E] mb-2">í˜•ì‹ì„ ê³¨ë¼ë³´ì„¸ìš” (ë§ì½ì´)</p>
              <div class="flex gap-4">
                <input type="radio" name="genre" value="column" id="column" class="hidden peer/column" onchange="showGuide(this.value)">
                <label for="column"
                  class="bg-white text-[#493E3E] px-4 py-2 rounded-full border border-gray-300 font-semibold cursor-pointer transition
                        peer-checked/column:bg-[#00C9A7] peer-checked/column:text-white">
                  ì¹¼ëŸ¼
                </label>

                <input type="radio" name="genre" value="analysis" id="analysis" class="hidden peer/analysis" onchange="showGuide(this.value)">
                <label for="analysis"
                  class="bg-white text-[#493E3E] px-4 py-2 rounded-full border border-gray-300 font-semibold cursor-pointer transition
                        peer-checked/analysis:bg-[#00C9A7] peer-checked/analysis:text-white">
                  ë¶„ì„ê¸€
                </label>
              </div>
            </div>

            <div id="prompt-box" class="mb-6" style="display: none;">
              <p class="font-semibold text-[#493E3E] mb-2 flex items-center">
                ğŸ“– ì˜¤ëŠ˜ì˜ ê¸€ê°ì„ ê³¨ë¼ë³´ì„¸ìš”
                <button type="button"
                  id="refreshPromptsBtn"
                  class="ml-2 px-2 py-1 mb-1 rounded bg-[#bae6fd] text-black text-xs border border-[#7dd3fc]">
                  ğŸ”„ ìƒˆë¡œìš´ ê¸€ê°
                </button>
                <button type="button"
                  id="customPromptBtn"
                  class="ml-2 px-2 py-1 mb-1 rounded bg-[#fef08a] text-black text-xs border border-[#fde68a]">
                  âœï¸ ì§ì ‘ ì…ë ¥
                </button>
              </p>
              <p class="text-xs text-gray-500 italic mb-4">
                ì˜¤ëŠ˜ì˜ ê¸€ê°ì€ <a href="https://www.bigkinds.or.kr/" target="_blank" class="underline hover:text-blue-600">ë¹…ì¹´ì¸ì¦ˆ</a>ì—ì„œ ì œê³µí•˜ëŠ” ì˜¤ëŠ˜ì˜ ì´ìŠˆ ê¸°ë°˜ìœ¼ë¡œ ë§¤ì¼ ì˜¤ì „ 9ì‹œì— ì´ˆê¸°í™”ë¼ìš” ğŸ•˜
              </p>
              <div id="prompt-options" class="grid grid-cols-1 gap-4"></div>
              <div id="customPromptInputBox" class="mt-2 hidden">
                <input type="text"
                  id="customPromptInput"
                  class="w-full border border-gray-300 px-4 py-2 rounded focus:outline-none focus:ring focus:border-blue-300"
                  placeholder="ê¸°ë¡í•˜ê³  ì‹¶ì€ ê¸€ê°ì„ ììœ ë¡­ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”!"
                  maxlength="100"
                />
                <button type="button" id="customPromptSelectBtn" class="mt-2 bg-[#bae6fd] px-3 py-1 rounded">ì„ íƒ</button>
              </div>
              <input type="hidden" name="topic" id="selectedPrompt">
              <input type="hidden" name="prompt_id" id="selectedPromptId">
            </div>

            <div class="flex justify-end mt-6">
              <button type="button" id="nextBtn" onclick="nextStep()" class="bg-[#bae6fd] px-4 py-2 rounded-full">
                ë‹¤ìŒ â†’
              </button>
            </div>
          </div>
      
          <div id="step-2" class="step-form">
            <div class="mb-6">
              <label class="block font-semibold text-[black] mb-1">ì»¤ë²„ ì´ë¯¸ì§€ ì—…ë¡œë“œ (ì„ íƒ)</label>
              <input type="file" name="cover_image" id="coverImageInput" accept="image/*" class="hidden" onchange="showCoverPreview(event)" />
              <button type="button" onclick="document.getElementById('coverImageInput').click();" class="bg-[#bae6fd] text-black text-xs px-3 py-2 rounded-full border">
                ì»¤ë²„ ì‚¬ì§„ ì„ íƒ
              </button>
              <div id="coverImagePreviewContainer" class="mt-4 hidden">
                <p class="text-sm text-[#bae6fd] font-semibold mb-1">ë¯¸ë¦¬ë³´ê¸°:</p>
                <img id="coverImagePreview" src="#" class="w-full h-48 object-cover rounded-lg border" />
              </div>
            </div>
            
            <div class="mb-6">
              <label class="block font-semibold text-[black] mb-1">ì œëª©</label>
              <input type="text" name="title" class="w-full border px-3 py-2 rounded-md" required />
            </div>
            
            <div class="mb-8">
              <p class="font-bold text-[black] text-lg mb-2">ğŸ§© ê¸€ì¤„ê¸°</p>
              <p class="text-sm text-gray-700 mb-3">í•œ/ë‘/ì„¸ ë°©ìš¸ì— ì“´ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ê¸€ì„ ì •ë¦¬í•´ë³´ì„¸ìš”</p>
              <textarea 
              name="final_text" 
              rows="10" 
              class="w-full border px-4 py-3 rounded-md shadow-sm" 
              spellcheck="false"
              required
              ></textarea>
            </div>
      
            <div class="flex justify-between mt-6">
              <button type="button" id="prevBtn" onclick="prevStep()" class="bg-gray-200 px-4 py-2 rounded-full">
                â† ì´ì „
              </button>
              <button type="submit" class="bg-[#bae6fd] hover:bg-[#7dd3fc] text-[#493E3E] font-bold px-6 py-3 rounded-full transition">
                ë³´ê´€í•˜ê¸°
              </button>
            </div>
          </div>
        </div>
      </main>
    </div>
</form>


<!-- âœ¨ ìˆ¨ê²¨ì§„ ê°€ì´ë“œ í…œí”Œë¦¿ ì €ì¥ì†Œ -->
<div id="guide-template-container" class="hidden">
  {% include "post/guide_combined.html" %}
</div>

<!-- ğŸ”¸ ëª¨ë‹¬ ì „ì²´ ë°°ê²½ -->
<div id="draftModal" class="fixed inset-0 bg-black bg-opacity-40 z-50 hidden flex justify-center items-center">
  <div class="bg-white rounded-xl w-[700px] h-[600px] shadow-xl relative p-8 flex flex-col">
    <button onclick="closeDraftModal()" class="absolute top-4 right-6 text-gray-400 hover:text-black text-2xl font-bold">Ã—</button>
    <!-- ê¸°ì¡´ ëª¨ë‹¬ ì•ˆ ì œëª© ì•„ë˜ì— ì´ ê°œìˆ˜ í‘œì‹œ ì¶”ê°€ -->
    <h2 class="text-2xl font-bold mb-3">ì„ì‹œì €ì¥ ê¸€</h2>
    <p id="draftTotal" class="text-base text-gray-500 mb-6">ì´ 0ê°œ</p>
    <hr>
    <br>
    <div id="draftListContainer" class="flex-1 overflow-y-auto space-y-4 text-base text-gray-700">
      <!-- ëª©ë¡ì´ ì—¬ê¸° ìë™ ì‚½ì…ë¨ -->
    </div>
  </div>
</div>


<script>
  let promptCache = {};
  let currentGenre = null;

  function showGenres(category) {
    document.getElementById('genre-logic').style.display = category === 'logic' ? 'block' : 'none';
    document.getElementById('genre-emotion').style.display = category === 'emotion' ? 'block' : 'none';
    document.querySelectorAll('input[name="genre"]').forEach(r => r.checked = false);
    document.getElementById("selectedPrompt").value = "";
    document.getElementById("prompt-options").innerHTML = "";
    document.getElementById("prompt-box").style.display = "none";
    // guide-scrollable ë¹„ìš¸ ë•Œ selected-prompt-displayëŠ” ë‚¨ê¸°ê³  ë‚˜ë¨¸ì§€ë§Œ ì‚­ì œ
    const scrollable = document.getElementById("guide-scrollable");
    while (scrollable.children.length > 1) {
      scrollable.removeChild(scrollable.lastChild);
    }
    document.getElementById("character-input").value = category;

      // âœ… ìˆ˜ì •: ì„ì‹œì €ì¥ê¸€ ë¶ˆëŸ¬ì˜¨ ìƒíƒœë¼ë©´ ê¸€ê° í‘œì‹œ ì˜ì—­ ìœ ì§€
    const editingIndex = localStorage.getItem("geulssung_editing_draft_index");
    if (!editingIndex) {
      // ìƒˆë¡œ ì‘ì„±í•˜ëŠ” ê¸€ì¼ ë•Œë§Œ ê¸€ê° í‘œì‹œ ì˜ì—­ ìˆ¨ê¸°ê¸°
      const displayBox = document.getElementById("selected-prompt-display");
      if (displayBox) displayBox.classList.add("hidden");
    }
  }

  function showGuide(value) {
    const genreMap = { essay: "ì—ì„¸ì´", poem: "ì‹œ", column: "ì¹¼ëŸ¼", analysis: "ë¶„ì„ê¸€" };
    currentGenre = genreMap[value];
    // â˜… í˜•ì‹(genre_type) ì €ì¥
    localStorage.setItem('geulssung_draft_genre_type', value);
    
    // í˜•ì‹ ì •ë³´ í‘œì‹œ
    const displayBox = document.getElementById('selected-prompt-display');
    const genreText = document.getElementById('selected-genre-text');
    if (genreText) {
      genreText.textContent = currentGenre;
      if (displayBox) displayBox.classList.remove('hidden');
    }
    
    fetchPrompts(currentGenre, renderPrompts);
    showGuideSidebar(value);
  }

  function showGuideSidebar(genre) {
    const templateId = `guide-template-${genre}`;
    const guideContainer = document.getElementById("guide-template-container");
    const scrollable = document.getElementById("guide-scrollable");
    const temp = guideContainer?.querySelector(`#${templateId}`);
    if (temp && scrollable) {
      // selected-prompt-displayëŠ” ë‚¨ê¸°ê³ , ë‚˜ë¨¸ì§€ guide-scrollable ìì‹ ëª¨ë‘ ì‚­ì œ
      while (scrollable.children.length > 1) {
        scrollable.removeChild(scrollable.lastChild);
      }
      // ê°€ì´ë“œ í…œí”Œë¦¿ ì‚½ì…
      const guideDiv = document.createElement("div");
      guideDiv.innerHTML = temp.innerHTML;
      scrollable.appendChild(guideDiv);
      // â˜… ì¥ë¥´ë³„ step drafts ìë™ ì €ì¥/ë³µì› ì„¸íŒ…
      setupStepDrafts(genre);
    } else {
      console.warn("ê°€ì´ë“œ ë¡œë”© ì‹¤íŒ¨:", genre);
    }
  }

  function fetchPrompts(genre, callback, forceRefresh = false) {
    // localStorage ìºì‹œ í‚¤
    const cacheKey = `geulssung_prompt_cache_${genre}`;
    if (!forceRefresh && localStorage.getItem(cacheKey)) {
      try {
        promptCache[genre] = JSON.parse(localStorage.getItem(cacheKey));
        if (callback) callback();
        return;
      } catch (e) {
        // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ìºì‹œ ë¬´ì‹œ
      }
    }
    fetch(`/prompts/api/random-prompts/?style=${encodeURIComponent(genre)}`)
      .then(res => res.json())
      .then(data => {
        promptCache[genre] = data.prompts;
        // ìºì‹œì— ì €ì¥
        localStorage.setItem(cacheKey, JSON.stringify(data.prompts));
        if (callback) callback();
      });
  }

  function selectCharacter(type) {
    const chatbot = document.getElementById('chatbot-character');
    const img = document.getElementById('chatbot-img');

    // ìºë¦­í„° ì´ë¯¸ì§€ ë³€ê²½
    if (type === 'emotion') {
      img.src = '/static/images/ê¸€ì½ì´.png'; // ê¸€ì½ì´ ì´ë¯¸ì§€ ê²½ë¡œ
      img.alt = 'ê¸€ì½ì´';
    } else if (type === 'logic') {
      img.src = '/static/images/ë§ì½ì´.png'; // ë§ì½ì´ ì´ë¯¸ì§€ ê²½ë¡œ
      img.alt = 'ë§ì½ì´';
    }

    // ì±—ë´‡ ë³´ì—¬ì£¼ê¸°
    chatbot.classList.remove('hidden');
  }

  function handleCharacterSelection(characterId) {
    // ë„ìš°ë¯¸ ì„ íƒ ì‹œ ì¥ë¥´ ì˜ì—­ í† ê¸€ (id ê¸°ì¤€)
    document.getElementById('genre-logic').style.display = characterId === 'logic' ? 'block' : 'none';
    document.getElementById('genre-emotion').style.display = characterId === 'emotion' ? 'block' : 'none';
    document.querySelectorAll('input[name="genre"]').forEach(r => r.checked = false);
    document.getElementById("selectedPrompt").value = "";
    document.getElementById("prompt-options").innerHTML = "";
    document.getElementById("prompt-box").style.display = "none";
    // ê°€ì´ë“œ ì´ˆê¸°í™” (selected-prompt-displayë§Œ ë‚¨ê¸°ê³  ì „ë¶€ ì œê±°)
    const guide = document.getElementById("guide-scrollable");
    [...guide.children].forEach(child => {
      if (!child.id || child.id !== "selected-prompt-display") {
        guide.removeChild(child);
      }
    });
    document.getElementById("character-input").value = characterId;

    // âœ… ìˆ˜ì •: ì„ì‹œì €ì¥ê¸€ ë¶ˆëŸ¬ì˜¨ ìƒíƒœë¼ë©´ ê¸€ê° í‘œì‹œ ì˜ì—­ ìœ ì§€
    const editingIndex = localStorage.getItem("geulssung_editing_draft_index");
    if (!editingIndex) {
      // ìƒˆë¡œ ì‘ì„±í•˜ëŠ” ê¸€ì¼ ë•Œë§Œ ê¸€ê° í‘œì‹œ ì˜ì—­ ìˆ¨ê¸°ê¸°
      const displayBox = document.getElementById("selected-prompt-display");
      if (displayBox) displayBox.classList.add("hidden");
    }

    // ìºë¦­í„° idë¥¼ urlìš©ìœ¼ë¡œ ë³€í™˜ (emotionâ†’1, logicâ†’2)
    const charUrlId = characterId === 'emotion' ? 1 : (characterId === 'logic' ? 2 : characterId);
    // ìºë¦­í„° ì´ë¯¸ì§€ ë‹¤ì‹œ ë Œë”ë§í•´ì„œ ë„£ê¸°
    fetch(`/geulssung/customizing/render-character/${charUrlId}/`)
      .then(res => res.text())
      .then(html => {
        const container = document.getElementById("character-container");
        container.innerHTML = html;
      })
      .catch(err => {
        const container = document.getElementById("character-container");
        container.innerHTML = '<div class="w-full h-full flex items-center justify-center text-gray-400">ìºë¦­í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
      });
    // â˜… ë„ìš°ë¯¸(ê°ì„±/ë…¼ë¦¬) ì €ì¥
    localStorage.setItem('geulssung_draft_genre', characterId);
  }



  function renderPrompts() {
    const genreInput = document.querySelector('input[name="genre"]:checked');
    if (!genreInput) return;
    const genreMap = { essay: "ì—ì„¸ì´", poem: "ì‹œ", column: "ì¹¼ëŸ¼", analysis: "ë¶„ì„ê¸€" };
    const genre = genreMap[genreInput.value];
    const prompts = promptCache[genre] || [];
    const promptOptions = document.getElementById("prompt-options");
    promptOptions.innerHTML = "";
    document.getElementById("selectedPrompt").value = "";
    if (!prompts.length) {
      promptOptions.innerHTML = "<div class='text-gray-400'>ê¸€ê°ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
      return;
    }
    prompts.forEach(prompt => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "prompt-option border rounded-xl p-4 hover:bg-[#FFF4E6] h-12 flex items-center";
      btn.textContent = prompt.content;
      btn.setAttribute("data-id", prompt.id);
      btn.onclick = () => selectPrompt(btn, prompt.content, prompt.id);
      promptOptions.appendChild(btn);
    });
    document.getElementById("prompt-box").style.display = "block";
    // â˜… ê¸€ê° ë³µì› (localStorage)
    if (window._restorePrompt) {
      window._restorePrompt();
      window._restorePrompt = null;
    }
  }

  // âœ… ğŸ‘‡ ì—¬ê¸°ì— ë³µì› í•¨ìˆ˜ ë¶™ì´ê¸°
  window._restorePrompt = function() {
    const savedPrompt = localStorage.getItem('geulssung_draft_prompt');
    const savedPromptId = localStorage.getItem('geulssung_draft_prompt_id');
    if (savedPrompt && savedPromptId) {
      // ê¸€ê° ë²„íŠ¼ì´ ë Œë”ë§ëœ í›„ì—ë§Œ ì‹¤í–‰
      const promptBtns = document.querySelectorAll('.prompt-option');
      let found = false;
      promptBtns.forEach(btn => {
        if (btn.textContent === savedPrompt && btn.getAttribute('data-id') == savedPromptId) {
          btn.click();
          found = true;
        }
      });
      // custom promptì¼ ê²½ìš°
      if (!found && savedPromptId === 'custom') {
        selectPrompt(null, savedPrompt, 'custom');
      }
    }
  };

  function selectPrompt(button, prompt, promptId) {
    // ë²„íŠ¼ ìƒ‰ìƒ ì´ˆê¸°í™”
    document.querySelectorAll('.prompt-option').forEach(btn => {
      btn.classList.remove('bg-[#FFEFD6]', 'ring', 'ring-[#F9DCC4]');
    });

    // ì„ íƒëœ ë²„íŠ¼ í•˜ì´ë¼ì´íŠ¸ (ë²„íŠ¼ì¼ ë•Œë§Œ)
    if (button && button.classList) {
      button.classList.add('bg-[#FFEFD6]', 'ring', 'ring-[#F9DCC4]');
    }

    // hidden inputì— ê°’ ì €ì¥
    document.getElementById('selectedPrompt').value = prompt;
    document.getElementById('selectedPromptId').value = promptId;

    // --- ê¸€ê° ì‚¬ì´ë“œë°”ì— í‘œì‹œ ---
    const displayBox = document.getElementById('selected-prompt-display');
    const displayText = document.getElementById('selected-prompt-text');
    if (prompt && displayBox && displayText) {
      displayText.textContent = prompt;
      displayBox.classList.remove('hidden');
    }

    // custom_prompt ì²˜ë¦¬
    const customPromptHidden = document.getElementById('customPromptHidden');
    if (promptId === "custom") {
      customPromptHidden.value = prompt;
    } else {
      customPromptHidden.value = "";
    }
    // â˜… ê¸€ê° ì €ì¥
    localStorage.setItem('geulssung_draft_prompt', prompt);
    localStorage.setItem('geulssung_draft_prompt_id', promptId);
  }

  function showCoverPreview(event) {
    const file = event.target.files[0];
    const previewContainer = document.getElementById('coverImagePreviewContainer');
    const previewImage = document.getElementById('coverImagePreview');
    if (file) {
      const reader = new FileReader();
      previewContainer.style.display = 'block';
      reader.onload = function (e) {
        previewImage.setAttribute('src', e.target.result);
      };
      reader.readAsDataURL(file);
    } else {
      previewContainer.style.display = 'none';
      previewImage.setAttribute('src', '');
    }
  }

  document.addEventListener("DOMContentLoaded", function () {
    // âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸€ì“°ê¸° ê´€ë ¨ ë°ì´í„°ë§Œ ì´ˆê¸°í™”
    function clearWritingDrafts() {
        // ì¥ë¥´/í˜•ì‹ ì„ íƒ ì´ˆê¸°í™”
        localStorage.removeItem('geulssung_draft_genre');
        localStorage.removeItem('geulssung_draft_genre_type');
        localStorage.removeItem('geulssung_draft_prompt');
        localStorage.removeItem('geulssung_draft_prompt_id');
        
        // ì œëª©, ë³¸ë¬¸ ì„ì‹œì €ì¥ ì´ˆê¸°í™”
        localStorage.removeItem('geulssung_draft_title');
        localStorage.removeItem('geulssung_draft_final_text');

        // âœ… ì¶”ê°€ëœ ë¶€ë¶„: í¸ì§‘ ì¤‘ì¸ ê¸€ ì¸ë±ìŠ¤ ì´ˆê¸°í™”
        localStorage.removeItem('geulssung_editing_draft_index');
        localStorage.removeItem('geulssung_selected_draft_index');
        
        ["essay", "poem", "column", "analysis"].forEach(genre => {
            for (let i = 1; i <= 3; i++) {
                localStorage.removeItem(`geulssung_draft_${genre}_step${i}`);
            }
        });
            
        // ì¥ë¥´ë³„ step drafts ì´ˆê¸°í™”
        ["essay", "poem", "column", "analysis"].forEach(genre => {
            for (let i = 1; i <= 3; i++) {
                localStorage.removeItem(`geulssung_draft_${genre}_step${i}`);
            }
        });
    }
    
    document.getElementById("refreshPromptsBtn").onclick = function () {
      if (!currentGenre) return;
      // ìºì‹œ ì‚­ì œ
      localStorage.removeItem(`geulssung_prompt_cache_${currentGenre}`);
      fetchPrompts(currentGenre, renderPrompts, true);
    };
    document.getElementById("customPromptBtn").onclick = function () {
      const box = document.getElementById("customPromptInputBox");
      box.classList.toggle("hidden");
      if (!box.classList.contains("hidden")) {
        document.getElementById("customPromptInput").focus();
      }
    };
    document.getElementById("customPromptSelectBtn").onclick = function () {
      const value = document.getElementById("customPromptInput").value.trim();
      if (value) {
        selectPrompt(null, value, "custom");
        document.getElementById("customPromptInputBox").classList.add("hidden");
        document.getElementById("customPromptInput").value = "";
        // --- ê¸€ê° ì‚¬ì´ë“œë°”ì— í‘œì‹œ ---
        const displayBox = document.getElementById('selected-prompt-display');
        const displayText = document.getElementById('selected-prompt-text');
        if (displayBox && displayText) {
          displayText.textContent = value;
          displayBox.classList.remove('hidden');
        }
      }
    };
    document.getElementById("customPromptInput").addEventListener("keydown", function(e) {
      if (e.key === "Enter") {
        e.preventDefault();
        document.getElementById("customPromptSelectBtn").click();
      }
    });
    showStep(1);
    // ììœ  ê¸€ê° ì…ë ¥ ì‹œ prompt_id ë¹„ìš°ê¸°
    const customPromptInput = document.getElementById('customPrompt');
    if (customPromptInput) {
      customPromptInput.addEventListener('input', function() {
        if (this.value.trim() !== "") {
          document.getElementById('selectedPrompt').value = this.value;
          document.getElementById('selectedPromptId').value = "";
          // ë²„íŠ¼ ì„ íƒ í•´ì œ
          document.querySelectorAll('.prompt-option').forEach(btn => {
            btn.classList.remove('bg-[#FFEFD6]', 'ring', 'ring-[#F9DCC4]');
          });
        }
      });
    }
    // ì´ˆê¸°í™” ì‹œ ê¸€ê° í‘œì‹œ ì˜ì—­ ìˆ¨ê¸°ê¸°
    const displayBox = document.getElementById('selected-prompt-display');
    if (displayBox) displayBox.classList.add('hidden');
    // genre, genre_type, prompt ë³µì›

    // ê¸€ê° ë³µì›ì€ fetchPrompts ì´í›„ì— ì‹¤í–‰í•´ì•¼ í•˜ë¯€ë¡œ renderPromptsì—ì„œ ì²˜ë¦¬
    window._restorePrompt = function() {
      const savedPrompt = localStorage.getItem("geulssung_draft_prompt");
      const savedPromptId = localStorage.getItem("geulssung_draft_prompt_id");

      if (savedPrompt && savedPromptId) {
        // ê¸€ê° ë²„íŠ¼ì´ ë Œë”ë§ëœ í›„ì—ë§Œ ì‹¤í–‰
        const promptBtns = document.querySelectorAll('.prompt-option');
        let found = false;
        promptBtns.forEach(btn => {
          if (btn.textContent === savedPrompt && btn.getAttribute('data-id') == savedPromptId) {
            btn.click();
            found = true;
          }
        });
        // custom promptì¼ ê²½ìš°
        if (!found && savedPromptId === 'custom') {
          selectPrompt(null, savedPrompt, 'custom');
        }
      }
    }
  });

  let isGuideVisible = true;

  function toggleGuide() {
    const guide = document.getElementById('guide-sidebar');
    const toggleBtn = document.getElementById('toggleGuideBtn');

    if (isGuideVisible) {
      guide.classList.add('hidden');
      toggleBtn.innerText = 'ğŸ“– ê°€ì´ë“œ í¼ì¹˜ê¸°';
    } else {
      guide.classList.remove('hidden');
      toggleBtn.innerText = 'ğŸ“š ê°€ì´ë“œ ì ‘ê¸°';
    }

    isGuideVisible = !isGuideVisible;
  }
  let currentStep = 1;

  function showStep(step) {
    document.querySelectorAll('.step-form').forEach((el, idx) => {
      el.classList.toggle('hidden', idx + 1 !== step);
    });

    document.getElementById("prevBtn").classList.toggle('hidden', step === 1);
    document.getElementById("nextBtn").innerText = step === 2 ? "ì œì¶œ" : "ë‹¤ìŒ â†’";

    currentStep = step;
  }

  function nextStep() {
    if (currentStep === 1) {
      showStep(2);
    } else {
      // 2ë‹¨ê³„ì—ì„œ ë‹¤ìŒ ëˆ„ë¥´ë©´ submit
      document.querySelector("form").submit();
    }
  }

  function prevStep() {
    if (currentStep > 1) {
      showStep(currentStep - 1);
    }
  }

  // â˜… ì¥ë¥´ë³„ step drafts ìë™ ì €ì¥/ë³µì› í•¨ìˆ˜
  function setupStepDrafts(genre) {
    for (let i = 1; i <= 3; i++) {
      const textarea = document.querySelector(`textarea[name="${genre}_step${i}"]`);
      const key = `geulssung_draft_${genre}_step${i}`;
      if (textarea) {
        // ë³µì›
        if (localStorage.getItem(key)) {
          textarea.value = localStorage.getItem(key);
        }
        // ì €ì¥
        textarea.addEventListener("input", () => {
          localStorage.setItem(key, textarea.value);
        });
      }
    }
  }

    // ğŸŸ¢ ìƒˆë¡œ ì¶”ê°€: ê¸€ì“°ê¸° ê°€ì´ë“œ ì´ˆê¸°í™” í•¨ìˆ˜
  function resetWritingGuideSteps(genre) {
    if (!genre) return;
    
    // DOM ìš”ì†Œ ì´ˆê¸°í™”
    const step1El = document.querySelector(`textarea[name="${genre}_step1"]`);
    const step2El = document.querySelector(`textarea[name="${genre}_step2"]`);
    const step3El = document.querySelector(`textarea[name="${genre}_step3"]`);

    if (step1El) step1El.value = "";
    if (step2El) step2El.value = "";
    if (step3El) step3El.value = "";

    // localStorageì—ì„œë„ í•´ë‹¹ ì¥ë¥´ì˜ step ë°ì´í„° ì œê±°
    localStorage.removeItem(`geulssung_draft_${genre}_step1`);
    localStorage.removeItem(`geulssung_draft_${genre}_step2`);
    localStorage.removeItem(`geulssung_draft_${genre}_step3`);
  }

  // 4. handleTemporarySave í•¨ìˆ˜ì—ì„œ í˜„ì¬ ì¥ë¥´ ì •ë³´ë„ í•¨ê»˜ ì €ì¥í•˜ë„ë¡ ìˆ˜ì •
  function handleTemporarySave() {
    try {
      console.log("ğŸŸ¢ ì„ì‹œì €ì¥ í•¨ìˆ˜ ì‹¤í–‰ë¨");

      const promptTitle = localStorage.getItem("geulssung_draft_prompt") || "ì œëª© ì—†ìŒ";
      const finalText = document.querySelector('textarea[name="final_text"]');
      const content = finalText?.value?.trim() || "";

      // âœ… í˜„ì¬ ì„ íƒëœ genre ê°€ì ¸ì˜¤ê¸° (ì²´í¬ëœ ë¼ë””ì˜¤ë²„íŠ¼ì—ì„œ)
      const genreRadio = document.querySelector('input[name="genre"]:checked');
      const genre = genreRadio?.value || "";

      const step1El = document.querySelector(`textarea[name="${genre}_step1"]`);
      const step2El = document.querySelector(`textarea[name="${genre}_step2"]`);
      const step3El = document.querySelector(`textarea[name="${genre}_step3"]`);

      const step1 = step1El?.value || "";
      const step2 = step2El?.value || "";
      const step3 = step3El?.value || "";

      const now = new Date();
      const timestamp = `${now.getFullYear()}.${String(now.getMonth() + 1).padStart(2, '0')}.${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;

      let drafts = JSON.parse(localStorage.getItem("geulssung_draft_list") || "[]");

      // ê¸€ê°(ì œëª©) ê¸°ì¤€ìœ¼ë¡œ ì´ë¯¸ ì €ì¥ëœ ê¸€ì´ ìˆëŠ”ì§€ ì°¾ê¸°
      const existingIndex = drafts.findIndex(d => d.title === promptTitle);

      if (existingIndex !== -1) {
        // ì´ë¯¸ ìˆëŠ” ê¸€ì´ë©´ ì—…ë°ì´íŠ¸
        drafts[existingIndex] = {
          ...drafts[existingIndex],
          content,
          timestamp,
          genre,
          step1,
          step2,
          step3,
          promptId: localStorage.getItem("geulssung_draft_prompt_id") || "custom"
        };
        alert("ê¸°ì¡´ ì„ì‹œì €ì¥ ê¸€ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
      } else {
        // ìƒˆ ê¸€ ì¶”ê°€
        const newDraft = {
          title: promptTitle,
          content,
          timestamp,
          genre,
          step1,
          step2,
          step3,
          promptId: localStorage.getItem("geulssung_draft_prompt_id") || "custom"
        };
        drafts.unshift(newDraft);
        alert("ì´ ê¸€ì´ ì„ì‹œì €ì¥ ë˜ì—ˆìŠµë‹ˆë‹¤.");
      }

      localStorage.setItem("geulssung_draft_list", JSON.stringify(drafts));

      const countEl = document.getElementById("draftCount");
      if (countEl) countEl.textContent = drafts.length;

      // ì¸ë±ìŠ¤ ì´ˆê¸°í™”
      localStorage.removeItem("geulssung_editing_draft_index");

    } catch (error) {
      console.error("âŒ ì„ì‹œì €ì¥ ì¤‘ ì˜¤ë¥˜:", error);
    }
  }

  function selectDraft(index) {
    // ì˜ˆ: ì‚¬ìš©ìê°€ ì²« ë²ˆì§¸ ê¸€ì„ ì„ íƒí–ˆì„ ë•Œ
    localStorage.setItem("geulssung_selected_draft", JSON.stringify(drafts[0]));
    window.location.href = "/geulssung/write/";  // ê¸€ì“°ê¸° í˜ì´ì§€ë¡œ ì´ë™
  }


  document.addEventListener("DOMContentLoaded", () => {
    const badge = document.getElementById("draftCountBadge");
    const drafts = JSON.parse(localStorage.getItem("geulssung_draft_list") || "[]");
    if (badge) badge.textContent = `${drafts.length}ê°œ`;

    updateDraftCount();
  });

    // 1. openDraftModal í•¨ìˆ˜ ìˆ˜ì • (ê¸°ì¡´ í•¨ìˆ˜ë¥¼ ì™„ì „íˆ êµì²´)
  function openDraftModal() {
    const modal = document.getElementById("draftModal");
    const container = document.getElementById("draftListContainer");
    const countText = document.getElementById("draftTotal");
    const drafts = JSON.parse(localStorage.getItem("geulssung_draft_list") || "[]");

    // ì´ ê°œìˆ˜ í‘œì‹œ
    if (countText) countText.textContent = `ì´ ${drafts.length}ê°œ`;

    container.innerHTML = "";

    if (drafts.length === 0) {
      container.innerHTML = "<p class='text-gray-500 text-center'>ì €ì¥ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
    } else {
      // í˜„ì¬ ì‘ì„±ì¤‘ì¸ ê¸€ê° í™•ì¸
      const currentPrompt = localStorage.getItem('geulssung_draft_prompt');
      
      drafts.forEach((draft, index) => {
        const item = document.createElement("div");
        item.className = "border-b pb-2 hover:bg-gray-100 rounded px-2 py-1 transition flex justify-between items-center";
        
        // í˜„ì¬ ì‘ì„±ì¤‘ì¸ ê¸€ê°ì¸ì§€ í™•ì¸
        const isCurrentDraft = currentPrompt && draft.title === currentPrompt;
        
        item.innerHTML = `
          <div class="cursor-pointer flex-1" onclick="selectDraftItem(${index})">
            <div class="font-semibold">${draft.title}</div>
            <div class="text-xs text-gray-500">${draft.timestamp}</div>
          </div>
          <div class="flex items-center gap-2">
            ${isCurrentDraft ? 
              '<span class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full font-semibold">ì‘ì„±ì¤‘</span>' : 
              '<button onclick="deleteDraft(' + index + ')" class="text-red-500 hover:text-red-700 text-sm px-2 py-1 rounded border border-red-300 hover:bg-red-50 transition">ğŸ—‘ï¸</button>'
            }
          </div>
        `;
        container.appendChild(item);
      });
    }

    modal.classList.remove("hidden");
  }

    // 2. ìƒˆë¡œìš´ í•¨ìˆ˜ë“¤ ì¶”ê°€
  function selectDraftItem(index) {
    const drafts = JSON.parse(localStorage.getItem("geulssung_draft_list") || "[]");
    const draft = drafts[index];
    const currentPrompt = localStorage.getItem('geulssung_draft_prompt');
    
    // í˜„ì¬ ì‘ì„±ì¤‘ì¸ ê¸€ì¸ì§€ í™•ì¸
    const isCurrentDraft = currentPrompt && draft.title === currentPrompt;
    
    if (isCurrentDraft) {
      alert("í˜„ì¬ ì‘ì„±ì¤‘ì¸ ê¸€ì…ë‹ˆë‹¤.");
      return;
    }
    
    const confirmed = confirm("ì´ ë¬¸ì„œë¥¼ ë¶ˆëŸ¬ì˜¤ë©´ í˜„ì¬ ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ì—†ì–´ì§‘ë‹ˆë‹¤. ì„ì‹œì €ì¥ í•œ í›„ ë¶ˆëŸ¬ì˜¤ê¸¸ ê¶Œì¥í•©ë‹ˆë‹¤.");
    if (confirmed) {
      // âœ… ìˆ˜ì •ëœ ë¶€ë¶„: í¸ì§‘ ì¤‘ì¸ ê¸€ì˜ ì¸ë±ìŠ¤ë¥¼ ì €ì¥
      // ì„ íƒëœ draftë¥¼ localStorageì— ì €ì¥ (ë³µì›ìš©)
      localStorage.setItem("geulssung_editing_draft_index", index);
      localStorage.setItem("geulssung_selected_draft_index", index);
      
      // draft ë³µì› ì‹¤í–‰
      restoreDraftToForm(draft);
      closeDraftModal();
    }
  }

  function deleteDraft(index) {
      const confirmed = confirm("ğŸ—‘ï¸ ì´ ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
      if (confirmed) {
          let drafts = JSON.parse(localStorage.getItem("geulssung_draft_list") || "[]");
          drafts.splice(index, 1);
          localStorage.setItem("geulssung_draft_list", JSON.stringify(drafts));
          // ê°œìˆ˜ ì—…ë°ì´íŠ¸
          updateDraftCount();
          // ëª¨ë‹¬ ë‹¤ì‹œ ì—´ê¸° (ëª©ë¡ ìƒˆë¡œê³ ì¹¨)
          openDraftModal();
      }
  }

  function closeDraftModal() {
    document.getElementById("draftModal").classList.add("hidden");
  }

  // 1. restoreDraftToForm í•¨ìˆ˜ ìˆ˜ì •
  function restoreDraftToForm(draft) {
    const promptBox = document.getElementById("selectedPrompt");
    const finalTextarea = document.querySelector('textarea[name="final_text"]');

    // ë³µì›ëœ ì œëª© â†’ ê¸€ê° ìœ„ì¹˜ì— í‘œì‹œ
    if (promptBox) promptBox.value = draft.title;

    // ë³µì›ëœ ë³¸ë¬¸ ë‚´ìš©
    if (finalTextarea) finalTextarea.value = draft.content;

    // ğŸŸ¢ ê¸€ê° ì œëª©ê³¼ IDë¥¼ ë‹¤ì‹œ localStorageì— ì €ì¥
    localStorage.setItem('geulssung_draft_prompt', draft.title);
    localStorage.setItem('geulssung_draft_prompt_id', draft.promptId || 'custom');

    // âœ… ì¥ë¥´ë³„ step ë°ì´í„° ë³µì› (ì¦‰ì‹œ ì‹¤í–‰)
    const genre = draft.genre;
    if (genre) {
      // localStorageì— step ë°ì´í„° ì €ì¥ (setupStepDraftsì—ì„œ ì½ì„ ìˆ˜ ìˆë„ë¡)
      localStorage.setItem(`geulssung_draft_${genre}_step1`, draft.step1 || "");
      localStorage.setItem(`geulssung_draft_${genre}_step2`, draft.step2 || "");
      localStorage.setItem(`geulssung_draft_${genre}_step3`, draft.step3 || "");

      // DOM ìš”ì†Œê°€ ì¡´ì¬í•œë‹¤ë©´ ì¦‰ì‹œ ë³µì›
      setTimeout(() => {
        const step1El = document.querySelector(`textarea[name="${genre}_step1"]`);
        const step2El = document.querySelector(`textarea[name="${genre}_step2"]`);
        const step3El = document.querySelector(`textarea[name="${genre}_step3"]`);

        if (step1El) step1El.value = draft.step1 || "";
        if (step2El) step2El.value = draft.step2 || "";
        if (step3El) step3El.value = draft.step3 || "";
      }, 100);
    }

    // ê¸€ê° í‘œì‹œ ì˜ì—­ ì—…ë°ì´íŠ¸
    const displayBox = document.getElementById('selected-prompt-display');
    const displayText = document.getElementById('selected-prompt-text');
    const genreText = document.getElementById('selected-genre-text');
    if (displayBox && displayText) {
      displayText.textContent = draft.title;
      // í˜•ì‹ ì •ë³´ë„ í‘œì‹œ
      if (genreText && genre) {
        const genreMap = { essay: "ì—ì„¸ì´", poem: "ì‹œ", column: "ì¹¼ëŸ¼", analysis: "ë¶„ì„ê¸€" };
        genreText.textContent = genreMap[genre] || genre;
      }
      displayBox.classList.remove('hidden');
    }
  }

  function updateDraftCount() {
    const count = JSON.parse(localStorage.getItem("geulssung_draft_list") || "[]").length;
    const draftCount = document.getElementById("draftCount");
    if (draftCount) draftCount.textContent = count;
  }

  function restoreGuideStepsFromDraft(draft) {
    const genre = document.querySelector('input[name="genre"]')?.value || "";

    const step2El = document.querySelector(`textarea[name="${genre}_step2"]`);
    const step3El = document.querySelector(`textarea[name="${genre}_step3"]`);
    const step4El = document.querySelector(`textarea[name="${genre}_step4"]`);

    if (step2El && draft.step2 !== undefined) step2El.value = draft.step2;
    if (step3El && draft.step3 !== undefined) step3El.value = draft.step3;
    if (step4El && draft.step4 !== undefined) step4El.value = draft.step4;
  }

  window.addEventListener("DOMContentLoaded", () => {
    setTimeout(() => {
      const draft = JSON.parse(localStorage.getItem("geulssung_selected_draft"));
      if (!draft) return;

      const genre = document.querySelector('input[name="genre"]')?.value;
      if (!genre) return;

      const step1El = document.querySelector(`textarea[name="${genre}_step1"]`);
      const step2El = document.querySelector(`textarea[name="${genre}_step2"]`);
      const step3El = document.querySelector(`textarea[name="${genre}_step3"]`);

      if (step1El) step1El.value = draft.step2 || "";
      if (step2El) step2El.value = draft.step3 || "";
      if (step3El) step3El.value = draft.step4 || "";
    }, 300); // ë Œë”ë§ ë”œë ˆì´ ë³´ì •
  });

  // ğŸŸ¢ ìë™ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° í†µí•©
  function restoreAllDrafts() {
    // ì œëª©
    const titleInput = document.querySelector('input[name="title"]');
    if (titleInput && localStorage.getItem('geulssung_draft_title')) {
      titleInput.value = localStorage.getItem('geulssung_draft_title');
    }
    // ë³¸ë¬¸
    const finalTextarea = document.querySelector('textarea[name="final_text"]');
    if (finalTextarea && localStorage.getItem('geulssung_draft_final_text')) {
      finalTextarea.value = localStorage.getItem('geulssung_draft_final_text');
    }
    // step drafts (ëª¨ë“  ì¥ë¥´)
    ["essay","poem","column","analysis"].forEach(genre => {
      for (let i = 1; i <= 3; i++) {
        const textarea = document.querySelector(`textarea[name="${genre}_step${i}"]`);
        const key = `geulssung_draft_${genre}_step${i}`;
        if (textarea && localStorage.getItem(key)) {
          textarea.value = localStorage.getItem(key);
        }
      }
    });
  }

  document.addEventListener("DOMContentLoaded", function () {
    restoreAllDrafts();
    // ì…ë ¥ì‹œë§ˆë‹¤ ì €ì¥
    const titleInput = document.querySelector('input[name="title"]');
    if (titleInput) {
      titleInput.addEventListener("input", () => {
        localStorage.setItem('geulssung_draft_title', titleInput.value);
      });
    }
    const finalTextarea = document.querySelector('textarea[name="final_text"]');
    if (finalTextarea) {
      finalTextarea.addEventListener("input", () => {
        localStorage.setItem('geulssung_draft_final_text', finalTextarea.value);
      });
    }
    // step drafts
    ["essay","poem","column","analysis"].forEach(genre => {
      for (let i = 1; i <= 3; i++) {
        const textarea = document.querySelector(`textarea[name="${genre}_step${i}"]`);
        const key = `geulssung_draft_${genre}_step${i}`;
        if (textarea) {
          textarea.addEventListener("input", () => {
            localStorage.setItem(key, textarea.value);
          });
        }
      }
    });
  });

</script>


<!-- ìºë¦­í„° ì „ì²´ ë°•ìŠ¤: ì‘ì„±í¼ ìš°ì¸¡ í•˜ë‹¨ì— ê³ ì •, width 20rem, right-4, bottom-4 -->
<div class="fixed right-4 bottom-4 z-50 flex flex-col items-end" style="width: 20rem;">
  <!-- ì±—ë´‡ ë§í’ì„  -->
  <div id="chat-box"
    class="hidden max-w-[90vw] w-[300px] bg-white rounded-2xl shadow-2xl p-5 border border-[#bae6fd]"
    style="box-shadow: 0 8px 32px rgba(0,0,0,0.18); pointer-events: auto; position: fixed; bottom: 320px; right: 40px; z-index: 50;">
    <div class="relative">
      <!-- ë§í’ì„  ê¼¬ë¦¬ ... -->
      <div style="position: absolute; left: 50%; bottom: -50px; transform: translateX(-50%); width: 0; height: 0; border-left: 18px solid transparent; border-right: 18px solid transparent; border-top: 18px solid #bae6fd;"></div>
      <div class="font-bold text-[#2563eb] text-lg mb-2 flex items-center gap-2">ğŸ“š ê¸€ì“°ê¸° ë„ìš°ë¯¸</div>
      <div id="chat-log" style="flex: 1; overflow-y: auto; min-height: 60px; max-height: 220px; padding: 10px 0 8px 0; font-size: 1rem;"></div>
      <div style="padding: 8px 0 0 0; display: flex; gap: 8px; align-items: flex-end; background: #f8fafc; border-radius: 0 0 16px 16px;">
        <textarea id="chat-input" placeholder="ë„ì›€ì„ ë°›ì•„ë³´ì„¸ìš”!" rows="2" style="flex: 1; resize: none; overflow-y: auto; max-height: 80px; line-height: 1.4; padding: 8px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem;"></textarea>
        <button id="chat-send-btn" style="padding: 8px 16px; height: fit-content; background: #bae6fd; color: #493E3E; border-radius: 8px; font-weight: bold; border: none; font-size: 1rem;">ì „ì†¡</button>
      </div>
    </div>
  </div>
  <!-- ìºë¦­í„° ì»¨í…Œì´ë„ˆ: relative ì œê±°, ê¸°ì¡´ì²˜ëŸ¼ -->
  <div class="-translate-y-3 -translate-x-3 flex flex-col items-center gap-4">
    <div id="character-container" class="relative inline-block w-[320px] h-[320px] pointer-events-auto">
      {% if not genre %}
        <div class="absolute inset-0 flex items-center justify-center text-gray-400 text-lg pointer-events-none z-10">
          ë„ìš°ë¯¸ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”!
        </div>
      {% else %}
        {% include "customizing/character_render.html" with character=character equipped_items=equipped_items %}
      {% endif %}
    </div>
  </div>
</div>

<button id="chat-toggle-btn" type="button"
  class="fixed bottom-[90px] right-[10rem] z-[999]
         bg-[#bae6fd] hover:bg-[#7dd3fc] text-[#493E3E] font-bold px-6 py-3 
         rounded-full shadow-xl text-lg transition-all duration-200 border-2 border-white 
         focus:outline-none focus:ring-2 focus:ring-[#bae6fd]">
  ìºë¦­í„° í´ë¦­!
</button>


<script>
// ì±—ë´‡ í† ê¸€ í•¨ìˆ˜: chat-boxì˜ hidden í† ê¸€ë§Œ ë‹´ë‹¹
function toggleChat() {
  const chatBox = document.getElementById("chat-box");
  if (chatBox) chatBox.classList.toggle("hidden");
}
</script>

<div id="chat-box-wrapper" class="fixed bottom-[-20px] right-[-20px] z-50 w-[34rem]">
</div>

<script src="{% static 'js/chatbot.js' %}"></script>

<script>
    function resetGuideSteps() {
      const genre = localStorage.getItem('geulssung_draft_genre_type'); // ì˜ˆ: essay, column ë“±
      if (!genre) {
        alert("í˜•ì‹ì´ ì„ íƒë˜ì–´ ìˆì§€ ì•Šì•„ ë¦¬ì…‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      for (let i = 1; i <= 3; i++) {
        const key = `geulssung_draft_${genre}_step${i}`;
        const textarea = document.querySelector(`textarea[name="${genre}_step${i}"]`);
        if (textarea) textarea.value = "";
        localStorage.removeItem(key);
      }

      alert("ê°€ì´ë“œ ì‘ì„± ë‚´ìš©ì´ ëª¨ë‘ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

  document.addEventListener("DOMContentLoaded", () => {
    const STORAGE_KEYS = {
      title: "geulssung_draft_prompt",
      final: "geulssung_draft_content",
    };

    const titleInput = document.querySelector('input[name="prompt"]');
    const finalTextarea = document.querySelector('textarea[name="final_text"]');

  // ë³µì›
  if (titleInput && localStorage.getItem(STORAGE_KEYS.title)) {
    titleInput.value = localStorage.getItem(STORAGE_KEYS.title);
  }
  if (finalTextarea && localStorage.getItem(STORAGE_KEYS.final)) {
    finalTextarea.value = localStorage.getItem(STORAGE_KEYS.final);
  }

  // ì €ì¥
  if (titleInput) {
    titleInput.addEventListener("input", () => {
      localStorage.setItem(STORAGE_KEYS.title, titleInput.value);
    });
  }

  if (finalTextarea) {
    finalTextarea.addEventListener("input", () => {
      localStorage.setItem(STORAGE_KEYS.final, finalTextarea.value);
    });
  }

  // í¼ ì œì¶œ ì‹œ localStorage ì´ˆê¸°í™”
  const form = document.querySelector("form");
    if (form) {
      form.addEventListener("submit", () => {
        localStorage.removeItem(STORAGE_KEYS.title);
        localStorage.removeItem(STORAGE_KEYS.final);
      });
    }
  });
</script>  
  
</body>
</html>