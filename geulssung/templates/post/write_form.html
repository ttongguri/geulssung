{% load static %}
<!DOCTYPE html>
<html lang="ko" style="font-size: 80%;">
<head>
  <meta charset="UTF-8">
  <title>ê¸€ì“°ê¸° âœï¸</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Gowun+Batang&display=swap');
    body { font-family: 'Gowun Batang', serif; }
    .guide-toggle summary {
      font-weight: bold;
      cursor: pointer;
      color: #493E3E;
      margin-bottom: 0.5rem;
    }
    .guide-toggle {
      margin-bottom: 1rem;
      border: 1px solid #ccc;
      border-radius: 0.5rem;
      padding: 0.5rem;
      background-color: #fff;
    }
  </style>
</head>
<body class="relative bg-[#FFF9F2] min-h-screen pt-4 pb-4 px-4 background">
  <style>
    .background{
      background-image: url('{% static "images/ë°”ë‹¤ë§Œ ë©ê·¸ëŸ¬ë‹ˆ2.png" %}'); 
      background-size: cover; 
      background-position: center; 
      background-repeat: no-repeat;
    }
  </style>
  {% include "nav_bar.html" %}
<!-- ì „ì²´ ë˜í¼ -->
<div class="bg-white max-w-[1100px] min-h-[600px] mx-auto mt-20 rounded-xl shadow-lg overflow-hidden flex">
  
    <!-- ì™¼ìª½: ê°€ì´ë“œ ì‚¬ì´ë“œë°” -->
    <aside id="guide-sidebar"
           class="w-[480px] border-r border-gray-200 flex flex-col">
      <!-- í—¤ë” -->
      <div class="sticky top-0 bg-white z-10 px-6 py-4 border-b">
        <p class="text-xl font-bold text-[#493E3E]">âœï¸ ê¸€ì“°ê¸° ê°€ì´ë“œ</p>
        <p class="text-sm text-gray-600">ì¥ë¥´ ì„ íƒ ì‹œ ì—¬ê¸°ì— ê°€ì´ë“œê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</p>
      </div>
      <!-- ìŠ¤í¬ë¡¤ ì˜ì—­ -->
      <div id="guide-scrollable"
           class="flex-1 overflow-y-auto px-6 py-4">
        <!-- ì„ íƒí•œ ê¸€ê° í‘œì‹œ ì˜ì—­ -->
        <div id="selected-prompt-display" class="mb-4 p-4 bg-[#f0f9ff] rounded text-sm text-[#0c4a6e] font-semibold hidden">
          ì„ íƒí•œ ê¸€ê°: <span id="selected-prompt-text"></span>
        </div>
        <!-- ê°€ì´ë“œ ì½˜í…ì¸  ì‚½ì… -->
      </div>
    </aside>
  
    <!-- ì˜¤ë¥¸ìª½: ê¸€ì“°ê¸° ë©”ì¸ -->
    <main id="writing-area"
          class="flex-1 p-6 overflow-y-auto">
      <div class="flex justify-end mb-4">
        <button id="toggleGuideBtn"
                onclick="toggleGuide()"
                class="bg-[#fde68a] text-black px-4 py-2 rounded-full text-sm shadow">
          ğŸ“š ê°€ì´ë“œ ì ‘ê¸°
        </button>
      </div>
      <form method="post" action="" enctype="multipart/form-data" class="h-full flex flex-col">
        {% csrf_token %}
        <input type="hidden" name="character" id="character-input" value="">
        <input type="hidden" name="custom_prompt" id="customPromptHidden">
  
        <div id="step-1" class="step-form flex-1">
      <div class="mb-6">
        <p class="font-semibold text-[#493E3E]">ì˜¤ëŠ˜ì˜ ê¸€ì“°ê¸° ë„ìš°ë¯¸</p>
        <div class="flex gap-4">
          <label><input type="radio" name="category" value="emotion" onchange="showGenres(this.value)"> Fê°ì„± ê¸€ì½ì´</label>
          <label><input type="radio" name="category" value="logic" onchange="showGenres(this.value)"> Tê°ì„± ë§ì½ì´</label>
        </div>
      </div>

      <div class="mb-6" id="genre-emotion" style="display:none;">
        <p class="font-semibold text-[#493E3E]">í˜•ì‹ì„ ê³¨ë¼ë³´ì„¸ìš” (ê¸€ì½ì´)</p>
        <div class="flex gap-4">
          <label><input type="radio" name="genre" value="essay" onchange="showGuide(this.value)"> ì—ì„¸ì´</label>
          <label><input type="radio" name="genre" value="poem" onchange="showGuide(this.value)"> ì‹œ</label>
        </div>
      </div>

      <div class="mb-6" id="genre-logic" style="display:none;">
        <p class="font-semibold text-[#493E3E]">í˜•ì‹ì„ ê³¨ë¼ë³´ì„¸ìš” (ë§ì½ì´)</p>
        <div class="flex gap-4">
          <label><input type="radio" name="genre" value="column" onchange="showGuide(this.value)"> ì¹¼ëŸ¼</label>
          <label><input type="radio" name="genre" value="analysis" onchange="showGuide(this.value)"> ë¶„ì„ê¸€</label>
        </div>
      </div>

      <div id="prompt-box" class="mb-6" style="display: none;">
        <p class="font-semibold text-[#493E3E] mb-2 flex items-center">
          ğŸ“– ì˜¤ëŠ˜ì˜ ê¸€ê°ì„ ê³¨ë¼ë³´ì„¸ìš”
          <button type="button"
            id="refreshPromptsBtn"
            class="ml-2 px-2 py-1 mb-1 rounded bg-[#bae6fd] text-black text-xs border border-[#7dd3fc]">
            ğŸ”„ ìƒˆë¡œìš´ ê¸€ê°
          </button>
          <button type="button"
            id="customPromptBtn"
            class="ml-2 px-2 py-1 mb-1 rounded bg-[#fef08a] text-black text-xs border border-[#fde68a]">
            âœï¸ ì§ì ‘ ì…ë ¥
          </button>
        </p>
        <p class="text-xs text-gray-500 italic mb-4">
          ì˜¤ëŠ˜ì˜ ê¸€ê°ì€ <a href="https://www.bigkinds.or.kr/" target="_blank" class="underline hover:text-blue-600">ë¹…ì¹´ì¸ì¦ˆ</a>ì—ì„œ ì œê³µí•˜ëŠ” ì˜¤ëŠ˜ì˜ ì´ìŠˆ ê¸°ë°˜ìœ¼ë¡œ ë§¤ì¼ ì˜¤ì „ 9ì‹œì— ì´ˆê¸°í™”ë¼ìš” ğŸ•˜
        </p>
        <div id="prompt-options" class="grid grid-cols-1 gap-4"></div>
        <!-- âœï¸ ììœ  ê¸€ê° ì§ì ‘ ì…ë ¥ (í† ê¸€) -->
        <div id="customPromptInputBox" class="mt-2 hidden">
          <input type="text"
            id="customPromptInput"
            class="w-full border border-gray-300 px-4 py-2 rounded focus:outline-none focus:ring focus:border-blue-300"
            placeholder="ê¸°ë¡í•˜ê³  ì‹¶ì€ ê¸€ê°ì„ ììœ ë¡­ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”!"
            maxlength="100"
          />
          <button type="button" id="customPromptSelectBtn" class="mt-2 bg-[#bae6fd] px-3 py-1 rounded">ì„ íƒ</button>
        </div>

        <!-- ì„ íƒëœ ê¸€ê° ê°’ì„ ì €ì¥ -->
        <input type="hidden" name="topic" id="selectedPrompt">
        <input type="hidden" name="prompt_id" id="selectedPromptId">
        </div>

        <div class="flex justify-end mt-6">
          <button type="button" id="nextBtn" onclick="nextStep()" class="bg-[#bae6fd] px-4 py-2 rounded-full">
            ë‹¤ìŒ â†’
          </button>
        </div>
      </div>
    <div id="step-2" class="step-form">

      <div class="mb-6">
        <label class="block font-semibold text-[black] mb-1">ì»¤ë²„ ì´ë¯¸ì§€ ì—…ë¡œë“œ (ì„ íƒ)</label>
        <input type="file" name="cover_image" id="coverImageInput" accept="image/*" class="hidden" onchange="showCoverPreview(event)" />
        <button type="button" onclick="document.getElementById('coverImageInput').click();" class="bg-[#bae6fd] text-black text-xs px-3 py-2 rounded-full border">
          ì»¤ë²„ ì‚¬ì§„ ì„ íƒ
        </button>
        <div id="coverImagePreviewContainer" class="mt-4 hidden">
          <p class="text-sm text-[#bae6fd] font-semibold mb-1">ë¯¸ë¦¬ë³´ê¸°:</p>
          <img id="coverImagePreview" src="#" class="w-full h-48 object-cover rounded-lg border" />
        </div>
      </div>
      
      <div class="mb-6">
        <label class="block font-semibold text-[black] mb-1">ì œëª©</label>
        <input type="text" name="title" class="w-full border px-3 py-2 rounded-md" required />
      </div>
      
      <div class="mb-8">
        <p class="font-bold text-[black] text-lg mb-2">ğŸ§© ê¸€ì¤„ê¸°</p>
        <p class="text-sm text-gray-700 mb-3">í•œ/ë‘/ì„¸ ë°©ìš¸ì— ì“´ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ê¸€ì„ ì •ë¦¬í•´ë³´ì„¸ìš”</p>
        <textarea name="final_text" rows="10" class="w-full border px-4 py-3 rounded-md shadow-sm" required></textarea>
      </div>

      <div class="flex justify-between mt-6">
        <button type="button" id="prevBtn" onclick="prevStep()" class="bg-gray-200 px-4 py-2 rounded-full">
          â† ì´ì „
        </button>
        <button type="submit" class="bg-[#bae6fd] hover:bg-[#7dd3fc] text-[#493E3E] font-bold px-6 py-3 rounded-full transition">
          ì œì¶œí•˜ê¸°
        </button>
      </div>
    </div>
    </form>
  </div>
</div>



<!-- âœ¨ ìˆ¨ê²¨ì§„ ê°€ì´ë“œ í…œí”Œë¦¿ ì €ì¥ì†Œ -->
<div id="guide-template-container" class="hidden">
  {% include "post/guide_combined.html" %}
</div>

<script>
  let promptCache = {};
  let currentGenre = null;

  function showGenres(category) {
    document.getElementById('genre-logic').style.display = category === 'logic' ? 'block' : 'none';
    document.getElementById('genre-emotion').style.display = category === 'emotion' ? 'block' : 'none';
    document.querySelectorAll('input[name="genre"]').forEach(r => r.checked = false);
    document.getElementById("selectedPrompt").value = "";
    document.getElementById("prompt-options").innerHTML = "";
    document.getElementById("prompt-box").style.display = "none";
    // guide-scrollable ë¹„ìš¸ ë•Œ selected-prompt-displayëŠ” ë‚¨ê¸°ê³  ë‚˜ë¨¸ì§€ë§Œ ì‚­ì œ
    const scrollable = document.getElementById("guide-scrollable");
    while (scrollable.children.length > 1) {
      scrollable.removeChild(scrollable.lastChild);
    }
    document.getElementById("character-input").value = category;
    // ê¸€ê° í‘œì‹œ ì˜ì—­ ìˆ¨ê¸°ê¸°
    const displayBox = document.getElementById("selected-prompt-display");
    if (displayBox) displayBox.classList.add("hidden");
  }

  function showGuide(value) {
    const genreMap = { essay: "ì—ì„¸ì´", poem: "ì‹œ", column: "ì¹¼ëŸ¼", analysis: "ë¶„ì„ê¸€" };
    currentGenre = genreMap[value];
    fetchPrompts(currentGenre, renderPrompts);
    showGuideSidebar(value);
  }

  function showGuideSidebar(genre) {
    const templateId = `guide-template-${genre}`;
    const guideContainer = document.getElementById("guide-template-container");
    const scrollable = document.getElementById("guide-scrollable");
    const temp = guideContainer?.querySelector(`#${templateId}`);
    if (temp && scrollable) {
      // selected-prompt-displayëŠ” ë‚¨ê¸°ê³ , ë‚˜ë¨¸ì§€ guide-scrollable ìì‹ ëª¨ë‘ ì‚­ì œ
      while (scrollable.children.length > 1) {
        scrollable.removeChild(scrollable.lastChild);
      }
      // ê°€ì´ë“œ í…œí”Œë¦¿ ì‚½ì…
      const guideDiv = document.createElement("div");
      guideDiv.innerHTML = temp.innerHTML;
      scrollable.appendChild(guideDiv);
    } else {
      console.warn("ê°€ì´ë“œ ë¡œë”© ì‹¤íŒ¨:", genre);
    }
  }

  function fetchPrompts(genre, callback, forceRefresh = false) {
    if (!forceRefresh && promptCache[genre]) {
      if (callback) callback();
      return;
    }
    fetch(`/prompts/api/random-prompts/?style=${encodeURIComponent(genre)}`)
      .then(res => res.json())
      .then(data => {
        promptCache[genre] = data.prompts;
        if (callback) callback();
      });
  }

  function renderPrompts() {
    const genreInput = document.querySelector('input[name="genre"]:checked');
    if (!genreInput) return;
    const genreMap = { essay: "ì—ì„¸ì´", poem: "ì‹œ", column: "ì¹¼ëŸ¼", analysis: "ë¶„ì„ê¸€" };
    const genre = genreMap[genreInput.value];
    const prompts = promptCache[genre] || [];
    const promptOptions = document.getElementById("prompt-options");
    promptOptions.innerHTML = "";
    document.getElementById("selectedPrompt").value = "";
    if (!prompts.length) {
      promptOptions.innerHTML = "<div class='text-gray-400'>ê¸€ê°ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
      return;
    }
    prompts.forEach(prompt => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "prompt-option border rounded-xl p-4 hover:bg-[#FFF4E6] h-12 flex items-center";
      btn.textContent = prompt.content;
      btn.setAttribute("data-id", prompt.id);
      btn.onclick = () => selectPrompt(btn, prompt.content, prompt.id);
      promptOptions.appendChild(btn);
    });
    document.getElementById("prompt-box").style.display = "block";
  }

  function selectPrompt(button, prompt, promptId) {
    // ë²„íŠ¼ ìƒ‰ìƒ ì´ˆê¸°í™”
    document.querySelectorAll('.prompt-option').forEach(btn => {
      btn.classList.remove('bg-[#FFEFD6]', 'ring', 'ring-[#F9DCC4]');
    });

    // ì„ íƒëœ ë²„íŠ¼ í•˜ì´ë¼ì´íŠ¸ (ë²„íŠ¼ì¼ ë•Œë§Œ)
    if (button && button.classList) {
      button.classList.add('bg-[#FFEFD6]', 'ring', 'ring-[#F9DCC4]');
    }

    // hidden inputì— ê°’ ì €ì¥
    document.getElementById('selectedPrompt').value = prompt;
    document.getElementById('selectedPromptId').value = promptId;

    // --- ê¸€ê° ì‚¬ì´ë“œë°”ì— í‘œì‹œ ---
    const displayBox = document.getElementById('selected-prompt-display');
    const displayText = document.getElementById('selected-prompt-text');
    if (prompt && displayBox && displayText) {
      displayText.textContent = prompt;
      displayBox.classList.remove('hidden');
    }

    // custom_prompt ì²˜ë¦¬
    const customPromptHidden = document.getElementById('customPromptHidden');
    if (promptId === "custom") {
      customPromptHidden.value = prompt;
    } else {
      customPromptHidden.value = "";
    }
  }

  function showCoverPreview(event) {
    const file = event.target.files[0];
    const previewContainer = document.getElementById('coverImagePreviewContainer');
    const previewImage = document.getElementById('coverImagePreview');
    if (file) {
      const reader = new FileReader();
      previewContainer.style.display = 'block';
      reader.onload = function (e) {
        previewImage.setAttribute('src', e.target.result);
      };
      reader.readAsDataURL(file);
    } else {
      previewContainer.style.display = 'none';
      previewImage.setAttribute('src', '');
    }
  }

  document.addEventListener("DOMContentLoaded", function () {
    document.getElementById("refreshPromptsBtn").onclick = function () {
      if (!currentGenre) return;
      fetchPrompts(currentGenre, renderPrompts, true);
    };
    document.getElementById("customPromptBtn").onclick = function () {
      const box = document.getElementById("customPromptInputBox");
      box.classList.toggle("hidden");
      if (!box.classList.contains("hidden")) {
        document.getElementById("customPromptInput").focus();
      }
    };
    document.getElementById("customPromptSelectBtn").onclick = function () {
      const value = document.getElementById("customPromptInput").value.trim();
      if (value) {
        selectPrompt(null, value, "custom");
        document.getElementById("customPromptInputBox").classList.add("hidden");
        document.getElementById("customPromptInput").value = "";
        // --- ê¸€ê° ì‚¬ì´ë“œë°”ì— í‘œì‹œ ---
        const displayBox = document.getElementById('selected-prompt-display');
        const displayText = document.getElementById('selected-prompt-text');
        if (displayBox && displayText) {
          displayText.textContent = value;
          displayBox.classList.remove('hidden');
        }
      }
    };
    document.getElementById("customPromptInput").addEventListener("keydown", function(e) {
      if (e.key === "Enter") {
        e.preventDefault();
        document.getElementById("customPromptSelectBtn").click();
      }
    });
    showStep(1);
    // ììœ  ê¸€ê° ì…ë ¥ ì‹œ prompt_id ë¹„ìš°ê¸°
    const customPromptInput = document.getElementById('customPrompt');
    if (customPromptInput) {
      customPromptInput.addEventListener('input', function() {
        if (this.value.trim() !== "") {
          document.getElementById('selectedPrompt').value = this.value;
          document.getElementById('selectedPromptId').value = "";
          // ë²„íŠ¼ ì„ íƒ í•´ì œ
          document.querySelectorAll('.prompt-option').forEach(btn => {
            btn.classList.remove('bg-[#FFEFD6]', 'ring', 'ring-[#F9DCC4]');
          });
        }
      });
    }
    // ì´ˆê¸°í™” ì‹œ ê¸€ê° í‘œì‹œ ì˜ì—­ ìˆ¨ê¸°ê¸°
    const displayBox = document.getElementById('selected-prompt-display');
    if (displayBox) displayBox.classList.add('hidden');
  });

  let isGuideVisible = true;

  function toggleGuide() {
    const guide = document.getElementById('guide-sidebar');
    const toggleBtn = document.getElementById('toggleGuideBtn');

    if (isGuideVisible) {
      guide.classList.add('hidden');
      toggleBtn.innerText = 'ğŸ“– ê°€ì´ë“œ í¼ì¹˜ê¸°';
    } else {
      guide.classList.remove('hidden');
      toggleBtn.innerText = 'ğŸ“š ê°€ì´ë“œ ì ‘ê¸°';
    }

    isGuideVisible = !isGuideVisible;
  }
  let currentStep = 1;

function showStep(step) {
  document.querySelectorAll('.step-form').forEach((el, idx) => {
    el.classList.toggle('hidden', idx + 1 !== step);
  });

  document.getElementById("prevBtn").classList.toggle('hidden', step === 1);
  document.getElementById("nextBtn").innerText = step === 2 ? "ì œì¶œ" : "ë‹¤ìŒ â†’";

  currentStep = step;
}

function nextStep() {
  if (currentStep === 1) {
    showStep(2);
  } else {
    // 2ë‹¨ê³„ì—ì„œ ë‹¤ìŒ ëˆ„ë¥´ë©´ submit
    document.querySelector("form").submit();
  }
}

function prevStep() {
  if (currentStep > 1) {
    showStep(currentStep - 1);
  }
}
</script>
<!-- âœ¨ ì±—ë´‡ ë°•ìŠ¤ -->
<div id="chat-box-wrapper" class="fixed bottom-24 right-4 w-[400px] z-50">
    <button onclick="toggleChat()" class="w-full bg-[#bae6fd] text-[#493E3E] font-bold py-2 rounded-t-xl transition">
      ğŸ’¬ ì±—ë´‡ ì—´ê¸° / ë‹«ê¸°
    </button>
    <div id="chat-box-content" class="hidden h-[400px] overflow-y-auto px-4 py-3">
      <p class="text-sm text-gray-500">ì±—ë´‡ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>
  </div>
  
  <script>
    function toggleChat() {
      const chatBox = document.getElementById("chat-box-content");
      chatBox.classList.toggle("hidden");
    }
  </script>
  
  <script src="{% static 'js/chatbot.js' %}"></script>
</body>
</html>