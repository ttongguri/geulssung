{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê¸€ì“°ê¸° âœï¸</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Gowun+Batang&display=swap');
    body { font-family: 'Gowun Batang', serif; }

     /* â”€â”€â”€ Step2: ë“œë¡­ë¦¿(í•œÂ·ë‘Â·ì„¸ ë°©ìš¸) ëª¨ë‘ ë³´ì´ê¸° â”€â”€â”€ */
     #step-2 .step {
       display: block !important;
     }
     /* ë“œë¡­ë¦¿ ë‚´ ë„¤ë¹„ ë²„íŠ¼(ì´ì „/ë‹¤ìŒ) ìˆ¨ê¸°ê¸° */
     #step-2 .step .flex.justify-between {
       display: none !important;
     }

    /* ìƒë‹¨ 5ë‹¨ê³„ ë„¤ë¹„ ìˆ¨ê¹€ */
    #step-nav { display: none; }
  </style>
</head>
<body class="bg-[#FFF9F2] min-h-screen p-8">

  <div class="max-w-3xl mx-auto relative bg-white rounded-xl shadow-xl p-6 mt-8">
    <form method="post" action="" enctype="multipart/form-data">
      {% csrf_token %}
      <input type="hidden" name="character" id="character-input" value="">

      <!-- STEP 1: ë„ìš°ë¯¸ / í˜•ì‹ / ê¸€ê° ì„ íƒ -->
      <div class="step" id="step-1">
        <!-- ë„ìš°ë¯¸ ì„ íƒ -->
        <div class="mb-6">
          <p class="font-semibold text-[#493E3E]">ì˜¤ëŠ˜ì˜ ê¸€ì“°ê¸° ë„ìš°ë¯¸</p>
          <div class="flex gap-4">
            <label><input type="radio" name="category" value="emotion" onchange="showGenres(this.value)"> Fê°ì„± ê¸€ì½ì´</label>
            <label><input type="radio" name="category" value="logic"  onchange="showGenres(this.value)"> Tê°ì„± ë§ì½ì´</label>
          </div>
        </div>

        <!-- í˜•ì‹ ì„ íƒ: ê¸€ì½ì´ -->
        <div class="mb-6" id="genre-emotion" style="display:none;">
          <p class="font-semibold text-[#493E3E]">í˜•ì‹ì„ ê³¨ë¼ë³´ì„¸ìš” (ê¸€ì½ì´)</p>
          <div class="flex gap-4">
            <label><input type="radio" name="genre" value="essay"  onchange="showGuide(this.value)"> ì—ì„¸ì´</label>
            <label><input type="radio" name="genre" value="poem"   onchange="showGuide(this.value)"> ì‹œ</label>
          </div>
        </div>

        <!-- í˜•ì‹ ì„ íƒ: ë§ì½ì´ -->
        <div class="mb-6" id="genre-logic" style="display:none;">
          <p class="font-semibold text-[#493E3E]">í˜•ì‹ì„ ê³¨ë¼ë³´ì„¸ìš” (ë§ì½ì´)</p>
          <div class="flex gap-4">
            <label><input type="radio" name="genre" value="column"   onchange="showGuide(this.value)"> ì¹¼ëŸ¼</label>
            <label><input type="radio" name="genre" value="analysis" onchange="showGuide(this.value)"> ë¶„ì„ê¸€</label>
          </div>
        </div>

        <!-- ê¸€ê° ì„ íƒ ë°•ìŠ¤ -->
        <div id="prompt-box" class="mb-6" style="display: none;">
          <p class="font-semibold text-[#493E3E] mb-2 flex items-center">
            ğŸ§  ì˜¤ëŠ˜ì˜ ê¸€ê°ì„ ê³¨ë¼ë³´ì„¸ìš”
            <button type="button" id="refreshPromptsBtn"
                    class="ml-2 px-2 py-1 rounded bg-[#bae6fd] text-black text-xs border border-[#7dd3fc]">
              ğŸ”„ ìƒˆë¡œìš´ ê¸€ê°
            </button>
          </p>
          <div id="prompt-options" class="grid grid-cols-1 gap-4"></div>
          <input type="hidden" name="topic" id="selectedPrompt">
          <input type="hidden" name="prompt_id" id="selectedPromptId">
        </div>

        <div class="flex justify-end">
          <button type="button" id="step1NextBtn"
                  class="bg-[#7dd3fc] text-black font-bold px-4 py-2 rounded-full
                         opacity-50 pointer-events-none"
                  onclick="nextStep()">
            ë‹¤ìŒ â†’
          </button>
        </div>
      </div>
      <!-- /STEP 1 -->

      <!-- STEP 2: í•œÂ·ë‘Â·ì„¸ ë°©ìš¸ + ê¸€ì¤„ê¸° -->
      <div class="step" id="step-2" style="display:none;">
        <!-- ì œì¶œ ë²„íŠ¼ -->
        <button type="submit"
                class="absolute top-6 right-6 bg-[#bae6fd] hover:bg-[#7dd3fc]
                       text-[#493E3E] font-bold px-4 py-2 rounded-full transition">
          ì œì¶œí•˜ê¸°
        </button>

        <div class="flex gap-4 mt-12">
          <!-- ì¢Œì¸¡: ë°©ìš¸ ê°€ì´ë“œ -->
          <div class="w-1/2 bg-white p-4 rounded shadow overflow-y-auto"
               style="max-height: calc(100vh - 200px);">
            <div id="guide-poem"     style="display:none;">{% include "post/_guide_poem.html"     %}</div>
            <div id="guide-essay"    style="display:none;">{% include "post/_guide_essay.html"    %}</div>
            <div id="guide-column"   style="display:none;">{% include "post/_guide_column.html"   %}</div>
            <div id="guide-analysis" style="display:none;">{% include "post/_guide_analysis.html" %}</div>
          </div>
          <!-- ìš°ì¸¡: ì»¤ë²„/ì œëª©/ê¸€ì¤„ê¸° -->
          <div class="w-1/2 bg-white p-4 rounded shadow overflow-y-auto"
               style="max-height: calc(100vh - 200px);">
            <!-- ì»¤ë²„ ì—…ë¡œë“œ -->
            <div class="mb-6">
              <label class="block font-semibold mb-1">ì»¤ë²„ ì´ë¯¸ì§€ ì—…ë¡œë“œ (ì„ íƒ)</label>
              <input type="file" name="cover_image" id="coverImageInput" accept="image/*" hidden
                     onchange="showCoverPreview(event)">
              <button type="button" onclick="document.getElementById('coverImageInput').click();"
                      class="bg-[#bae6fd] text-black text-xs px-3 py-2 rounded-full border border-[#7dd3fc] shadow">
                ì»¤ë²„ ì‚¬ì§„ ì„ íƒ
              </button>
              <div id="coverImagePreviewContainer" class="mt-4 hidden">
                <p class="text-sm text-[#bae6fd] font-semibold mb-1">ë¯¸ë¦¬ë³´ê¸°:</p>
                <img id="coverImagePreview" src="#" class="w-full h-48 object-cover rounded-lg border" />
              </div>
            </div>
            <!-- ì œëª© -->
            <div class="mb-6">
              <label class="block font-semibold mb-1">ì œëª©</label>
              <input type="text" name="title" class="w-full border px-3 py-2 rounded-md" required>
            </div>
            <!-- ê¸€ì¤„ê¸° -->
            <div>
              <p class="font-bold text-lg mb-2">ğŸ§© ê¸€ì¤„ê¸°: í•˜ë‚˜ì˜ ê¸€ë¡œ ì™„ì„±í•´ë³´ì„¸ìš”</p>
              <p class="text-sm text-gray-700 mb-3">
                ìœ„ ë‹¨ê³„ë³„ ì‘ì„± ë‚´ìš©ì„ ì°¸ê³ í•˜ì—¬, í•˜ë‚˜ì˜ íë¦„ ìˆëŠ” ê¸€ë¡œ ì •ë¦¬í•˜ì„¸ìš”.<br>
                ì´ ê¸€ì€ ì‹¤ì œ ì œì¶œ ë° ê³µê°œ ê¸€ë¡œ ì‚¬ìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤ âœï¸
              </p>
              <textarea name="final_text" rows="10"
                        class="w-full border px-4 py-3 rounded-md shadow-sm" required></textarea>
            </div>
            <div class="flex justify-start mt-4">
              <button type="button" onclick="prevStep()"
                      class="bg-gray-200 px-4 py-2 rounded-full">â† ì´ì „</button>
            </div>
          </div>
        </div>
      </div>
      <!-- /STEP 2 -->

    </form>
  </div>

  <!-- ì±—ë´‡ -->
  <div id="chat-box-wrapper" class="fixed bottom-4 right-4 w-[400px] z-50">
    <button onclick="toggleChat()"
            class="w-full bg-[#bae6fd] text-[#493E3E] font-bold py-2 rounded-t-xl">
      ğŸ’¬ ì±—ë´‡ ì—´ê¸° / ë‹«ê¸°
    </button>
  </div>

  <script src="{% static 'js/chatbot.js' %}"></script>
  <script>
    // ì „ì—­ ë§µ
    const genreMap = {
      essay: "ì—ì„¸ì´",
      poem: "ì‹œ",
      column: "ì¹¼ëŸ¼",
      analysis: "ë¶„ì„ê¸€"
    };

    let currentStep = 1;
    const totalSteps = 2;
    let currentGenre = null;
    const promptCache = {};

    // 1) APIì—ì„œ ê¸€ê° ë¶ˆëŸ¬ì˜¤ê¸°
    function fetchPrompts(genre, callback, forceRefresh=false) {
      if (!forceRefresh && promptCache[genre]) {
        if (callback) callback();
        return;
      }
      fetch(`/prompts/api/random-prompts/?style=${encodeURIComponent(genre)}`)
        .then(res => res.json())
        .then(data => {
          promptCache[genre] = data.prompts;
          if (callback) callback();
        });
    }

    // 2) ë²„íŠ¼ìœ¼ë¡œ ë Œë”ë§
    function renderPrompts() {
      const sel = document.querySelector('input[name="genre"]:checked');
      if (!sel) return;
      const genre = genreMap[sel.value];
      const prompts = promptCache[genre] || [];
      const container = document.getElementById("prompt-options");
      container.innerHTML = "";
      document.getElementById("selectedPrompt").value = "";
      document.getElementById("selectedPromptId").value = "";
      // ë²„íŠ¼ ë¹„í™œì„±í™” ìƒíƒœ ì´ˆê¸°í™”
      document.getElementById("step1NextBtn")
              .classList.add("opacity-50","pointer-events-none");

      if (!prompts.length) {
        container.innerHTML = "<div class='text-gray-400'>ê¸€ê°ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
      } else {
        prompts.forEach(p => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "prompt-option border rounded-xl p-4 hover:bg-[#FFF4E6] flex items-center";
          btn.textContent = p.content;
          btn.dataset.id = p.id;
          btn.onclick = () => selectPrompt(btn, p.content, p.id);
          container.appendChild(btn);
        });
      }
      document.getElementById("prompt-box").style.display = "block";
    }

    // 3) ì„ íƒ íš¨ê³¼
    function selectPrompt(btn, content, id) {
      document.querySelectorAll(".prompt-option")
              .forEach(x => x.classList.remove("bg-[#FFEFD6]","ring","ring-[#F9DCC4]"));
      btn.classList.add("bg-[#FFEFD6]","ring","ring-[#F9DCC4]");
      document.getElementById("selectedPrompt").value   = content;
      document.getElementById("selectedPromptId").value = id;
      checkFormReady();
    }

    // 4) ë‹¤ìŒ ë²„íŠ¼ í™œì„±í™” ì—¬ë¶€
    function checkFormReady() {
      const cat = document.querySelector('input[name="category"]:checked');
      const gen = document.querySelector('input[name="genre"]:checked');
      const pr  = document.getElementById("selectedPrompt").value;
      const btn = document.getElementById("step1NextBtn");
      if (cat && gen && pr) btn.classList.remove("opacity-50","pointer-events-none");
      else                   btn.classList.add("opacity-50","pointer-events-none");
    }

    // 5) helper â†’ í˜•ì‹ â†’ ê¸€ê° íë¦„
    function showGenres(category) {
      document.getElementById("genre-emotion").style.display = category==="emotion" ? "block":"none";
      document.getElementById("genre-logic").style.display   = category==="logic"   ? "block":"none";
      // ì´ì „ì— ê³¨ëë˜ ì¥ë¥´/í”„ë¡¬í”„íŠ¸ ì´ˆê¸°í™”
      document.querySelectorAll('input[name="genre"]').forEach(x=>x.checked=false);
      document.getElementById("prompt-box").style.display = "none";
      document.getElementById("prompt-options").innerHTML = "";
      document.getElementById("selectedPrompt").value = "";
      document.getElementById("selectedPromptId").value = "";
      document.getElementById("character-input").value = category;
      checkFormReady();
    }

    function showGuide(value) {
      currentGenre = value;
      fetchPrompts(genreMap[value], renderPrompts);
      checkFormReady();
    }

    // 6) ìŠ¤í… ì „í™˜
    function showStep(n) {
      document.querySelectorAll(".step").forEach(x=>x.style.display="none");
      document.getElementById(`step-${n}`).style.display = "block";
    }
    function nextStep() {
      if (!document.getElementById("selectedPrompt").value) {
        return alert("ê¸€ê°ì„ ì„ íƒí•´ì£¼ì„¸ìš”!");
      }
      currentStep = 2;
      // ê°€ì´ë“œ ë³´ì´ê¸°
      document.querySelectorAll("[id^=guide-]").forEach(d=>d.style.display="none");
      document.getElementById(`guide-${currentGenre}`).style.display = "block";
      showStep(2);
    }
    function prevStep() {
      currentStep = 1;
      showStep(1);
    }

    document.addEventListener("DOMContentLoaded", ()=> {
      showStep(1);
      document.getElementById("refreshPromptsBtn").onclick = ()=>{
        if (currentGenre) fetchPrompts(genreMap[currentGenre], renderPrompts, true);
      };
    });

    // (ì»¤ë²„ ë¯¸ë¦¬ë³´ê¸° í•¨ìˆ˜: ê¸°ì¡´ì— ì“°ì‹œë˜ ê±° ê·¸ëŒ€ë¡œ ì“°ì‹œë©´ ë©ë‹ˆë‹¤)
    function showCoverPreview(e) {
      const file = e.target.files[0];
      if (!file) return;
      const img = document.getElementById("coverImagePreview");
      img.src = URL.createObjectURL(file);
      document.getElementById("coverImagePreviewContainer").classList.remove("hidden");
    }
  </script>
</body>
</html>
